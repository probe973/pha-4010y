<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Random Pharmacy Questions</title>
    <link rel="stylesheet" href="assets/css/style.css">
    <link rel="icon" href="/pha-4010y/favicon.ico" type="image/x-icon">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <script type="text/javascript" id="MathJax-script">
        window.MathJax = {
            tex: {
                inlineMath: [['$', '$'], ['\\(', '\\)']]
            },
            options: {
                // Removed 'scale' option here to rely on CSS 'font-size: 1em !important;' from style.css
            },
            svg: {
                fontCache: 'global'
            }
        };
    </script>
    <script type="text/javascript" id="MathJax-script"
        src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js">
    </script>
</head>
<body>

    <div class="navbar">
        <a href="index.html" class="navbar-link">Home</a>
        <span class="navbar-title" id="quizTitle">Random Questions</span>
    </div>

    <div class="content">
        <h1>Generate Practice Questions</h1>

        <!-- Topic Selection Section -->
        <div id="topicSelection" class="quiz-container">
            <h2>Select a Topic</h2>
            <p>Choose a topic to generate 10 random questions.</p>
            <div class="topic-link-container">
                <button class="topic-button" data-topic="unit_conversion">
                    <i class="fas fa-ruler-combined topic-icon"></i> Unit Conversions
                </button>
                <button class="topic-button" data-topic="concentration_conversion">
                    <i class="fas fa-flask topic-icon"></i> Concentration Conversions
                </button>
                <button class="topic-button" data-topic="dosage_volume">
                    <i class="fas fa-pills topic-icon"></i> Dosage & Volume
                </button>
                <!-- Other topic buttons are still removed for now -->
            </div>
        </div>

        <!-- Quiz Section (hidden initially) -->
        <div id="quizSection" style="display: none;">
            <div class="status-bar">
                <span>Question: <span id="currentQuestionNum">1</span> / <span id="totalQuestions">10</span></span>
                <span>Score: <span id="scoreTracker">0</span></span>
                <span>Time: <span id="timeTracker">0 minutes</span></span>
            </div>

            <div class="quiz-container">
                <p class="question-number" id="questionNumberDisplay"></p>
                <p class="question-text" id="questionText"></p>
                <div class="answer-input-container">
                    <input type="text" id="userAnswerInput" placeholder="Enter your answer" class="text-input">
                    <span id="answerUnitDisplay" class="unit-display"></span>
                </div>

                <div class="feedback-message" id="feedbackMessage"></div>
                
                <div class="button-group">
                    <button id="checkAnswerBtn">Check Answer</button>
                    <button id="nextQuestionBtn" disabled>Next Question</button>
                    <button id="restartQuizBtn" style="display: none;">Restart Quiz</button>
                </div>
            </div>
        </div>

        <!-- Quiz Summary Section (hidden initially) -->
        <div class="quiz-summary" id="quizSummary" style="display: none;">
            <h2>Quiz Complete!</h2>
            <p>Your final score: <span id="finalScore"></span> out of <span id="finalTotal"></span></p>
            <p>Time taken: <span id="finalTime"></span></p>
            <div class="button-group">
                <button id="summaryRestartBtn">Restart Quiz</button>
                <button id="backToTopicsBtn">Back to Topics</button>
            </div>
        </div>
    </div>

    <footer style="text-align: center; margin-top: 50px; padding: 20px; font-size: 0.8em; color: #666;">
        <p>Icons by <a href="https://fontawesome.com/" target="_blank" rel="noopener noreferrer">Font Awesome</a>, licensed under <a href="https://creativecommons.org/licenses/by/4.0/" target="_blank" rel="noopener noreferrer">CC BY 4.0</a>.</p>
        <p>Mathematical typesetting by <a href="https://www.mathjax.org/" target="_blank" rel="noopener noreferrer">MathJax</a>.</p>
        <p>Styled with <a href="https://tailwindcss.com/" target="_blank" rel="noopener noreferrer">Tailwind CSS</a>.</p>
    </footer>

    <script>
        let currentQuizQuestions = [];
        let currentQuestionIndex = 0;
        let score = 0;
        let timerInterval;
        let secondsElapsed = 0;
        let selectedTopicId = null;

        const topicSelectionDiv = document.getElementById('topicSelection');
        const quizSectionDiv = document.getElementById('quizSection');
        const quizSummaryDiv = document.getElementById('quizSummary');

        const questionNumberDisplay = document.getElementById('questionNumberDisplay');
        const questionText = document.getElementById('questionText');
        const userAnswerInput = document.getElementById('userAnswerInput');
        const answerUnitDisplay = document.getElementById('answerUnitDisplay');
        const feedbackMessage = document.getElementById('feedbackMessage');
        const checkAnswerBtn = document.getElementById('checkAnswerBtn');
        const nextQuestionBtn = document.getElementById('nextQuestionBtn');
        const restartQuizBtn = document.getElementById('restartQuizBtn');
        const summaryRestartBtn = document.getElementById('summaryRestartBtn');
        const backToTopicsBtn = document.getElementById('backToTopicsBtn');
        const scoreTracker = document.getElementById('scoreTracker');
        const timeTracker = document.getElementById('timeTracker');
        const currentQuestionNum = document.getElementById('currentQuestionNum');
        const totalQuestionsSpan = document.getElementById('totalQuestions');
        const quizTitle = document.getElementById('quizTitle');

        const TOTAL_QUESTIONS_PER_QUIZ = 10;
        const FLOATING_POINT_TOLERANCE = 1e-9;

        // --- Helper Functions ---
        function getRandomInt(min, max) {
            return Math.floor(Math.random() * (max - min + 1)) + min;
        }
        
        function getRandomDecimal(min, max, decimalPlaces) {
            const factor = Math.pow(10, decimalPlaces);
            return (Math.floor(Math.random() * (max * factor - min * factor + 1)) + min * factor) / factor;
        }

        function formatNumberForDisplay(num, maxDecimalPlaces) {
            if (num === null || !isFinite(num)) return '';
            let formatted = num.toFixed(maxDecimalPlaces);
            return parseFloat(formatted).toString();
        }
        
        function isClinicallySensible(num) {
            if (num === null || !isFinite(num)) return false;
            const diff = num - Math.floor(num);
            if (diff === 0 || diff === 0.5 || diff === 0.25 || diff === 0.75 || diff === 0.1 || diff === 0.2 || diff === 0.3 || diff === 0.4 || diff === 0.6 || diff === 0.7 || diff === 0.8 || diff === 0.9) {
                return true;
            }
            return false;
        }

        const unitDecimalCleanliness = {
            'kg': 2, 'g': 2, 'mg': 0, 'mcg': 0,
            'l': 2, 'ml': 0, 'mcL': 0,
            'km': 2, 'm': 0, 'cm': 0, 'mm': 0,
            '%w/v': 1,
            '%w/w': 1,
            'mg/mL': 1,
            'ratio_X': 1
        };


        // --- Question Generation Functions (Topic Specific) ---

        const questionGenerators = {
            'unit_conversion': function() {
                const conversionRules = [
                    { from: 'kg', to: 'g', generate: () => { const qVal = getRandomDecimal(0.1, 10, 1); return { q: qVal, a: qVal * 1000 }; } },
                    { from: 'g', to: 'kg', generate: () => { const qVal = getRandomDecimal(100, 5000, 0); return { q: qVal, a: qVal / 1000 }; } },
                    { from: 'g', to: 'mg', generate: () => { const qVal = getRandomDecimal(0.1, 5, 1); return { q: qVal, a: qVal * 1000 }; } },
                    { from: 'mg', to: 'g', generate: () => { const qVal = getRandomDecimal(100, 5000, 0); return { q: qVal, a: qVal / 1000 }; } },
                    { from: 'mg', to: 'mcg', generate: () => { const qVal = getRandomDecimal(0.1, 5, 1); return { q: qVal, a: qVal * 1000 }; } },
                    { from: 'mcg', to: 'mg', generate: () => { const qVal = getRandomDecimal(100, 5000, 0); return { q: qVal, a: qVal / 1000 }; } },
                    { from: 'g', to: 'mcg', generate: () => { const qVal = getRandomDecimal(0.01, 1, 2); return { q: qVal, a: qVal * 1000000 }; } },
                    { from: 'mcg', to: 'g', generate: () => { const qVal = getRandomDecimal(1000, 100000, 0); return { q: qVal, a: qVal / 1000000 }; } },
                    { from: 'l', to: 'ml', generate: () => { const qVal = getRandomDecimal(0.1, 5, 1); return { q: qVal, a: qVal * 1000 }; } },
                    { from: 'ml', to: 'l', generate: () => { const qVal = getRandomDecimal(100, 5000, 0); return { q: qVal, a: qVal / 1000 }; } },
                    { from: 'ml', to: 'mcL', generate: () => { const qVal = getRandomDecimal(0.1, 5, 1); return { q: qVal, a: qVal * 1000 }; } },
                    { from: 'm', to: 'cm', generate: () => { const qVal = getRandomDecimal(0.5, 5, 1); return { q: qVal, a: qVal * 100 }; } },
                    { from: 'cm', to: 'm', generate: () => { const qVal = getRandomDecimal(50, 500, 0); return { q: qVal, a: qVal / 100 }; } },
                    { from: 'm', to: 'mm', generate: () => { const qVal = getRandomDecimal(0.1, 2, 1); return { q: qVal, a: qVal * 1000 }; } },
                    { from: 'mm', to: 'cm', generate: () => { const qVal = getRandomDecimal(10, 100, 0); return { q: qVal, a: qVal / 10 }; } },
                    { from: 'cm', to: 'mm', generate: () => { const qVal = getRandomDecimal(1, 15, 1); return { q: qVal, a: qVal * 10 }; } }
                ];
                
                const rule = conversionRules[getRandomInt(0, conversionRules.length - 1)];
                const pair = rule.generate();

                const qVal = pair.q;
                const correctAnswer = pair.a;
                
                const qMaxDecimals = qVal % 1 === 0 ? 0 : 2;
                const ansMaxDecimals = 3; // Use a reasonable default for display
                
                const formattedQuestionValueDisplay = formatNumberForDisplay(qVal, qMaxDecimals);
                
                return {
                    question: `What is <strong>${formattedQuestionValueDisplay} ${rule.from}</strong> expressed in ${rule.to}?`,
                    correctAnswer: correctAnswer,
                    units: rule.to,
                    answerDisplayDecimals: ansMaxDecimals
                };
            },

            'concentration_conversion': function() {
                let questionData = null;
                let attempts = 0;
                const MAX_ATTEMPTS = 100;

                const concentrationRules = [
                    { type: '%w/v_to_mg/ml', questionUnitDisplay: '%w/v', answerUnitDisplay: 'mg/mL',
                      generate: () => { let qVal = getRandomDecimal(0.1, 79.9, 1); let aVal = qVal * 10; return { q: qVal, a: aVal }; }
                    },
                    { type: 'mg/ml_to_%w/v', questionUnitDisplay: 'mg/mL', answerUnitDisplay: '%w/v',
                      generate: () => { let qVal = getRandomDecimal(1, 800, 1); let aVal = qVal / 10; return { q: qVal, a: aVal }; }
                    },
                    { type: '1_in_X_to_mg/ml', questionUnitDisplay: '1 in X', answerUnitDisplay: 'mg/mL',
                      generate: () => { const sensibleXValues = [10, 20, 25, 40, 50, 80, 100, 125, 200, 250, 400, 500, 1000, 2.5, 5, 12.5, 16, 62.5]; let qVal = sensibleXValues[getRandomInt(0, sensibleXValues.length - 1)]; let aVal = 1000 / qVal; return { q: qVal, a: aVal }; }
                    },
                    { type: 'mg/ml_to_1_in_X', questionUnitDisplay: 'mg/mL', answerUnitDisplay: '', internalAnswerUnit: 'ratio_X',
                      generate: () => { const sensibleMgmlValuesFor1InX = [2, 4, 5, 8, 10, 12.5, 16, 20, 25, 40, 50, 80, 100, 125, 200, 250, 400, 500]; let qVal = sensibleMgmlValuesFor1InX[getRandomInt(0, sensibleMgmlValuesFor1InX.length - 1)]; let aVal = 1000 / qVal; return { q: qVal, a: aVal }; }
                    },
                    { type: 'dose_volume_to_concentration', questionUnitDisplay: '', answerUnitDisplay: 'mg/mL',
                      generate: () => { let dose = getRandomDecimal(10, 10000, 0); let volume = getRandomDecimal(10, 500, 0); let concentration = dose / volume; return { q_dose: dose, q_volume: volume, a: concentration }; }
                    }
                ];

                while (questionData === null && attempts < MAX_ATTEMPTS) {
                    attempts++;
                    const rule = concentrationRules[getRandomInt(0, concentrationRules.length - 1)];
                    const generatedValues = rule.generate.call(rule);

                    if (generatedValues === null || !isClinicallySensible(generatedValues.a)) {
                        continue;
                    }

                    let questionText;
                    let qValDec = 2;

                    if (rule.type === 'dose_volume_to_concentration') {
                        const formattedDose = formatNumberForDisplay(generatedValues.q_dose, 0);
                        const formattedVolume = formatNumberForDisplay(generatedValues.q_volume, 0);
                        questionText = `If <strong>${formattedDose} mg</strong> of a drug is dissolved in <strong>${formattedVolume} ml</strong> of solution, what is the concentration in <strong>mg/mL</strong>?`;
                    } else {
                        qValDec = generatedValues.q % 1 === 0 ? 0 : 2;
                        const formattedQuestionValue = formatNumberForDisplay(generatedValues.q, qValDec);
                        if (rule.questionUnitDisplay === '1 in X') {
                            questionText = `What is <strong>1 in ${formattedQuestionValue}</strong> expressed as ${rule.answerUnitDisplay}?`;
                        } else if (rule.questionUnitDisplay === 'mg/mL' && rule.internalAnswerUnit === 'ratio_X') {
                            questionText = `What is <strong>${formattedQuestionValue} mg/mL</strong> expressed as 1 in X? Enter the value of X.`;
                        } else {
                            questionText = `What is <strong>${formattedQuestionValue} ${rule.questionUnitDisplay}</strong> expressed as ${rule.answerUnitDisplay}?`;
                        }
                    }

                    questionData = {
                        question: questionText,
                        correctAnswer: generatedValues.a,
                        units: rule.answerUnitDisplay,
                        internalAnswerUnit: rule.internalAnswerUnit,
                        answerDisplayDecimals: generatedValues.a % 1 === 0 ? 0 : 2
                    };
                }

                if (questionData === null) {
                    return {
                        question: "Could not generate a sensible concentration conversion question. Please try again.",
                        correctAnswer: 0, units: "", answerDisplayDecimals: 0
                    };
                }
                return questionData;
            },

            'dosage_volume': function() {
                let questionData = null;
                let attempts = 0;
                const MAX_ATTEMPTS = 500;

                const sensibleConcValues = [0.01, 0.05, 0.1, 0.25, 0.5, 1, 1.25, 2, 2.5, 5, 8, 10, 12.5, 20, 25, 50, 100];
                const sensibleDoseValues = [1, 2, 2.5, 5, 10, 15, 20, 25, 30, 40, 50, 75, 100, 125, 150, 200, 250, 300, 400, 500, 750, 1000];
                const sensibleVolumeValues = [1, 2, 2.5, 5, 10, 15, 20, 25, 30, 40, 50, 75, 100, 125, 150, 200, 250, 300, 400, 500];

                const dosageVolumeRules = [
                    { type: 'calculate_dose', answerUnitDisplay: 'mg',
                      generate: () => {
                          const conc = sensibleConcValues[getRandomInt(0, sensibleConcValues.length - 1)];
                          const vol = sensibleVolumeValues[getRandomInt(0, sensibleVolumeValues.length - 1)];
                          const dose = conc * vol;
                          return { q_conc: conc, q_vol: vol, a: dose };
                      }
                    },
                    { type: 'calculate_volume', answerUnitDisplay: 'ml',
                      generate: () => {
                          const dose = sensibleDoseValues[getRandomInt(0, sensibleDoseValues.length - 1)];
                          const conc = sensibleConcValues[getRandomInt(0, sensibleConcValues.length - 1)];
                          if (conc === 0) return null;
                          const vol = dose / conc;
                          return { q_dose: dose, q_conc: conc, a: vol };
                      }
                    },
                    { type: 'calculate_w_w_ingredient', answerUnitDisplay: (ans) => ans < 1 ? 'mg' : 'g',
                      generate: () => {
                          const percent_ww = [0.05, 0.1, 0.25, 0.5, 1, 2, 2.5, 5, 10, 12.5, 20][getRandomInt(0, 10)];
                          const total_g = [10, 20, 25, 30, 50, 100, 125, 200, 250, 500][getRandomInt(0, 9)];
                          const active_ingredient_g = (percent_ww / 100) * total_g;
                          return { q_percent_ww: percent_ww, q_total_g: total_g, a: active_ingredient_g };
                      }
                    },
                    { type: 'calculate_volume_from_dose_and_percent_solution', answerUnitDisplay: 'ml',
                      generate: () => {
                          const percent_wv = [0.1, 0.25, 0.5, 1, 2, 2.5, 5, 10, 12.5][getRandomInt(0, 8)];
                          const questionDoseUnit = Math.random() < 0.5 ? 'mg' : 'g';
                          const questionDoseValue = sensibleDoseValues[getRandomInt(0, sensibleDoseValues.length - 1)] / (questionDoseUnit === 'g' ? 1000 : 1);
                          const required_dose_mg = questionDoseValue * (questionDoseUnit === 'g' ? 1000 : 1);
                          if (percent_wv === 0) return null;
                          const volume_needed = required_dose_mg / (percent_wv * 10);
                          return { q_dose_val: questionDoseValue, q_dose_unit: questionDoseUnit, q_percent_wv: percent_wv, a: volume_needed };
                      }
                    }
                ];

                while (questionData === null && attempts < MAX_ATTEMPTS) {
                    attempts++;
                    const rule = dosageVolumeRules[getRandomInt(0, dosageVolumeRules.length - 1)];
                    const generatedValues = rule.generate.call(rule);
                    
                    if (generatedValues === null || !isClinicallySensible(generatedValues.a)) {
                        continue;
                    }
                    
                    let questionText;
                    let answerUnit = typeof rule.answerUnitDisplay === 'function' ? rule.answerUnitDisplay(generatedValues.a) : rule.answerUnitDisplay;
                    let answerDecimals = isClinicallySensible(generatedValues.a) && generatedValues.a % 1 === 0 ? 0 : 2;

                    if (rule.type === 'calculate_dose') {
                        const formattedConc = formatNumberForDisplay(generatedValues.q_conc, isClinicallySensible(generatedValues.q_conc) && generatedValues.q_conc % 1 === 0 ? 0 : 2);
                        const formattedVol = formatNumberForDisplay(generatedValues.q_vol, 0);
                        questionText = `If a solution has a concentration of <strong>${formattedConc} mg/mL</strong>, how many milligrams of drug are in <strong>${formattedVol} ml</strong> of this solution?`;
                    } else if (rule.type === 'calculate_volume') {
                        const formattedConc = formatNumberForDisplay(generatedValues.q_conc, isClinicallySensible(generatedValues.q_conc) && generatedValues.q_conc % 1 === 0 ? 0 : 2);
                        const formattedDose = formatNumberForDisplay(generatedValues.q_dose, 0);
                        questionText = `How many millilitres of a solution with a concentration of <strong>${formattedConc} mg/mL</strong> would be required to provide a dose of <strong>${formattedDose} mg</strong>?`;
                    } else if (rule.type === 'calculate_w_w_ingredient') {
                        const totalGDec = isClinicallySensible(generatedValues.q_total_g) && generatedValues.q_total_g % 1 === 0 ? 0 : 2;
                        const percentWWDec = isClinicallySensible(generatedValues.q_percent_ww) && generatedValues.q_percent_ww % 1 === 0 ? 0 : 2;
                        questionText = `A cream is described as <strong>${formatNumberForDisplay(generatedValues.q_percent_ww, percentWWDec)}% w/w</strong>. How much active ingredient is there in <strong>${formatNumberForDisplay(generatedValues.q_total_g, totalGDec)} g</strong> of this cream?`;
                    } else if (rule.type === 'calculate_volume_from_dose_and_percent_solution') {
                        const qDoseDec = isClinicallySensible(generatedValues.q_dose_val) && generatedValues.q_dose_val % 1 === 0 ? 0 : 2;
                        const percentWVDec = isClinicallySensible(generatedValues.q_percent_wv) && generatedValues.q_percent_wv % 1 === 0 ? 0 : 2;
                        questionText = `How many ml of solution are required to provide a dose of <strong>${formatNumberForDisplay(generatedValues.q_dose_val, qDoseDec)} ${generatedValues.q_dose_unit}</strong> from a <strong>${formatNumberForDisplay(generatedValues.q_percent_wv, percentWVDec)}% w/v</strong> solution?`;
                    } else {
                        console.error(`Unknown rule type: ${rule.type}`);
                        continue;
                    }
                    
                    questionData = {
                        question: questionText,
                        correctAnswer: generatedValues.a,
                        units: answerUnit,
                        answerDisplayDecimals: answerDecimals
                    };
                }

                if (questionData === null) {
                    return {
                        question: "Could not generate a sensible dosage & volume question. Please try again.",
                        correctAnswer: 0, units: "", answerDisplayDecimals: 0
                    };
                }
                return questionData;
            }
        };

        // --- Core Quiz Logic ---

        function startQuiz(topicId) {
            selectedTopicId = topicId;
            const selectedTopicGenerator = questionGenerators[topicId];
            if (typeof selectedTopicGenerator !== 'function') {
                alert('Invalid topic selected or generator not found!');
                console.error("Generator for topic '" + topicId + "' is not a function:", selectedTopicGenerator);
                return;
            }

            currentQuizQuestions = [];
            for (let i = 0; i < TOTAL_QUESTIONS_PER_QUIZ; i++) {
                try {
                    const question = selectedTopicGenerator();
                    if (question) {
                        currentQuizQuestions.push(question);
                    } else {
                        i--;
                    }
                } catch (e) {
                    console.error(`Error generating question for topic ${topicId}:`, e);
                    alert(`Error generating question for this topic. Please try another topic or refresh. Details: ${e.message}`);
                    return;
                }
            }
            
            currentQuestionIndex = 0;
            score = 0;
            secondsElapsed = 0;
            scoreTracker.textContent = score;
            totalQuestionsSpan.textContent = TOTAL_QUESTIONS_PER_QUIZ;
            quizTitle.textContent = formatTopicTitle(topicId);

            topicSelectionDiv.style.display = 'none';
            quizSummaryDiv.style.display = 'none';
            quizSectionDiv.style.display = 'block';

            checkAnswerBtn.disabled = false;
            nextQuestionBtn.disabled = true;
            userAnswerInput.value = '';
            userAnswerInput.disabled = false;

            startTimer();
            displayQuestion();
        }

        function displayQuestion() {
            if (currentQuestionIndex >= currentQuizQuestions.length) {
                endQuiz();
                return;
            }

            const question = currentQuizQuestions[currentQuestionIndex];
            currentQuestionNum.textContent = currentQuestionIndex + 1;
            questionText.innerHTML = question.question;
            userAnswerInput.value = '';
            userAnswerInput.disabled = false;
            answerUnitDisplay.textContent = question.units;
            feedbackMessage.style.display = 'none';
            feedbackMessage.className = 'feedback-message';

            if (window.MathJax) {
                MathJax.typesetPromise([questionText]).catch((err) => console.error("MathJax typesetting error:", err));
            }

            checkAnswerBtn.disabled = false;
            nextQuestionBtn.disabled = true;
            userAnswerInput.focus();
        }

        function checkAnswer() {
            const userAnswerRaw = userAnswerInput.value;
            const userAnswer = parseFloat(userAnswerRaw);

            if (isNaN(userAnswer)) {
                feedbackMessage.textContent = "Please enter a numerical answer.";
                feedbackMessage.className = 'feedback-message feedback-incorrect';
                feedbackMessage.style.display = 'block';
                return;
            }

            const currentQuestion = currentQuizQuestions[currentQuestionIndex];
            const correctAnswer = currentQuestion.correctAnswer;
            
            // This is the new, correct comparison logic.
            if (Math.abs(userAnswer - correctAnswer) < FLOATING_POINT_TOLERANCE) {
                score++;
                feedbackMessage.textContent = "Correct!";
                feedbackMessage.className = 'feedback-message feedback-correct';
            } else {
                let feedbackAnswerDisplayString;
                const answerDecimals = currentQuestion.answerDisplayDecimals;
                
                if (currentQuestion.internalAnswerUnit === 'ratio_X') {
                    feedbackAnswerDisplayString = `1 in ${formatNumberForDisplay(correctAnswer, answerDecimals)}`;
                } else if (typeof currentQuestion.units === 'function') {
                    const unit = currentQuestion.units(correctAnswer);
                    const convertedAnswer = unit === 'mg' ? correctAnswer * 1000 : correctAnswer;
                    const decimals = convertedAnswer % 1 === 0 ? 0 : 2;
                    feedbackAnswerDisplayString = `${formatNumberForDisplay(convertedAnswer, decimals)} ${unit}`;
                } else {
                    feedbackAnswerDisplayString = `${formatNumberForDisplay(correctAnswer, answerDecimals)} ${currentQuestion.units}`;
                }

                feedbackMessage.textContent = `Incorrect. The correct answer was ${feedbackAnswerDisplayString}.`;
                feedbackMessage.className = 'feedback-message feedback-incorrect';
            }

            scoreTracker.textContent = score;
            feedbackMessage.style.display = 'block';

            checkAnswerBtn.disabled = true;
            nextQuestionBtn.disabled = false;
            userAnswerInput.disabled = true;
        }

        function nextQuestion() {
            currentQuestionIndex++;
            displayQuestion();
        }

        function endQuiz() {
            clearInterval(timerInterval);
            quizSummaryDiv.style.display = 'block';
            quizSectionDiv.style.display = 'none';

            document.getElementById('finalScore').textContent = score;
            document.getElementById('finalTotal').textContent = TOTAL_QUESTIONS_PER_QUIZ;
            document.getElementById('finalTime').textContent = formatTime(secondsElapsed);
        }

        function startTimer() {
            clearInterval(timerInterval);
            secondsElapsed = 0;
            timeTracker.textContent = formatTime(secondsElapsed);
            timerInterval = setInterval(() => {
                secondsElapsed++;
                timeTracker.textContent = formatTime(secondsElapsed);
            }, 1000);
        }

        function formatTime(totalSeconds) {
            const minutes = Math.floor(totalSeconds / 60);
            const remainingSeconds = totalSeconds % 60;
            return `${minutes} minute${minutes === 1 ? '' : 's'} ${remainingSeconds} second${remainingSeconds === 1 ? '' : 's'}`;
        }

        function formatTopicTitle(topicId) {
            return topicId.replace(/_/g, ' ').replace(/\b\w/g, char => char.toUpperCase()) + ' Questions';
        }

        // --- Event Listeners ---
        document.querySelectorAll('.topic-button').forEach(button => {
            button.addEventListener('click', (event) => {
                const topic = event.currentTarget.dataset.topic;
                startQuiz(topic);
            });
        });

        checkAnswerBtn.addEventListener('click', checkAnswer);
        nextQuestionBtn.addEventListener('click', nextQuestion);
        summaryRestartBtn.addEventListener('click', () => startQuiz(selectedTopicId));

        backToTopicsBtn.addEventListener('click', () => {
            quizSummaryDiv.style.display = 'none';
            topicSelectionDiv.style.display = 'block';
            quizTitle.textContent = 'Random Questions';
        });

        userAnswerInput.addEventListener('keypress', (event) => {
            if (event.key === 'Enter') {
                if (!checkAnswerBtn.disabled) {
                    checkAnswer();
                } else if (!nextQuestionBtn.disabled) {
                    nextQuestion();
                }
            }
        });

        // --- Initial Setup ---
        window.onload = () => {
            topicSelectionDiv.style.display = 'block';
            quizSectionDiv.style.display = 'none';
            quizSummaryDiv.style.display = 'none';
        };

    </script>
</body>
</html>
