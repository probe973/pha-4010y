<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Random Pharmacy Questions</title>
    <link rel="stylesheet" href="assets/css/style.css">
    <link rel="icon" href="/pha-4010y/favicon.ico" type="image/x-icon">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <script type="text/javascript" id="MathJax-script">
        // MathJax is still loaded for potential future use or if questions themselves have math,
        // but solution explanations will no longer use it.
        window.MathJax = {
            tex: {
                inlineMath: [['$', '$'], ['\\(', '\\)']]
            },
            options: {
                // Removed 'scale' option here to rely on CSS 'font-size: 1em !important;' from style.css
            },
            svg: {
                fontCache: 'global'
            }
        };
    </script>
    <script type="text/javascript" id="MathJax-script"
        src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js">
    </script>
</head>
<body>

    <div class="navbar">
        <a href="index.html" class="navbar-link">Home</a>
        <span class="navbar-title" id="quizTitle">Random Questions</span>
    </div>

    <div class="content">
        <h1>Generate Practice Questions</h1>

        <!-- Topic Selection Section -->
        <div id="topicSelection" class="quiz-container">
            <h2>Select a Topic</h2>
            <p>Choose a topic to generate 10 random questions.</p>
            <div class="topic-link-container">
                <button class="topic-button" data-topic="unit_conversion">
                    <i class="fas fa-ruler-combined topic-icon"></i> Unit Conversions
                </button>
                <button class="topic-button" data-topic="concentration_conversion">
                    <i class="fas fa-flask topic-icon"></i> Concentration Conversions
                </button>
                <button class="topic-button" data-topic="dosage_volume">
                    <i class="fas fa-pills topic-icon"></i> Dosage & Volume
                </button>
                <!-- Other topic buttons are still removed for now -->
            </div>
        </div>

        <!-- Quiz Section (hidden initially) -->
        <div id="quizSection" style="display: none;">
            <div class="status-bar">
                <span>Question: <span id="currentQuestionNum">1</span> / <span id="totalQuestions">10</span></span>
                <span>Score: <span id="scoreTracker">0</span></span>
                <span>Time: <span id="timeTracker">0 minutes</span></span>
            </div>

            <div class="quiz-container">
                <p class="question-number" id="questionNumberDisplay"></p>
                <p class="question-text" id="questionText"></p>
                <div class="answer-input-container">
                    <input type="text" id="userAnswerInput" placeholder="Enter your answer" class="text-input">
                    <span id="answerUnitDisplay" class="unit-display"></span>
                </div>

                <div class="feedback-message" id="feedbackMessage"></div>
                <!-- Solution explanation div is hidden and will not be populated -->
                <div class="solution-explanation" id="solutionExplanation" style="display: none;"></div>

                <div class="button-group">
                    <button id="checkAnswerBtn">Check Answer</button>
                    <button id="nextQuestionBtn" disabled>Next Question</button>
                    <button id="restartQuizBtn" style="display: none;">Restart Quiz</button>
                </div>
            </div>
        </div>

        <!-- Quiz Summary Section (hidden initially) -->
        <div class="quiz-summary" id="quizSummary" style="display: none;">
            <h2>Quiz Complete!</h2>
            <p>Your final score: <span id="finalScore"></span> out of <span id="finalTotal"></span></p>
            <p>Time taken: <span id="finalTime"></span></p>
            <div class="button-group">
                <button id="summaryRestartBtn">Restart Quiz</button>
                <button id="backToTopicsBtn">Back to Topics</button>
            </div>
        </div>
    </div>

    <footer style="text-align: center; margin-top: 50px; padding: 20px; font-size: 0.8em; color: #666;">
        <p>Icons by <a href="https://fontawesome.com/" target="_blank" rel="noopener noreferrer">Font Awesome</a>, licensed under <a href="https://creativecommons.org/licenses/by/4.0/" target="_blank" rel="noopener noreferrer">CC BY 4.0</a>.</p>
        <p>Mathematical typesetting by <a href="https://www.mathjax.org/" target="_blank" rel="noopener noreferrer">MathJax</a>.</p>
        <p>Styled with <a href="https://tailwindcss.com/" target="_blank" rel="noopener noreferrer">Tailwind CSS</a>.</p>
    </footer>

    <script>
        let currentQuizQuestions = []; // Stores the 10 generated questions for the current quiz
        let currentQuestionIndex = 0;
        let score = 0;
        let timerInterval;
        let secondsElapsed = 0;
        let selectedTopicId = null; // Store the ID of the currently selected topic

        // UI Elements
        const topicSelectionDiv = document.getElementById('topicSelection');
        const quizSectionDiv = document.getElementById('quizSection');
        const quizSummaryDiv = document.getElementById('quizSummary');

        const questionNumberDisplay = document.getElementById('questionNumberDisplay');
        const questionText = document.getElementById('questionText');
        const userAnswerInput = document.getElementById('userAnswerInput');
        const answerUnitDisplay = document.getElementById('answerUnitDisplay');
        const feedbackMessage = document.getElementById('feedbackMessage');
        const solutionExplanation = document.getElementById('solutionExplanation'); // This will now remain hidden
        const checkAnswerBtn = document.getElementById('checkAnswerBtn');
        const nextQuestionBtn = document.getElementById('nextQuestionBtn');
        const restartQuizBtn = document.getElementById('restartQuizBtn');
        const summaryRestartBtn = document.getElementById('summaryRestartBtn');
        const backToTopicsBtn = document.getElementById('backToTopicsBtn');
        const scoreTracker = document.getElementById('scoreTracker');
        const timeTracker = document.getElementById('timeTracker');
        const currentQuestionNum = document.getElementById('currentQuestionNum');
        const totalQuestionsSpan = document.getElementById('totalQuestions'); // Total questions in this quiz (fixed at 10)
        const quizTitle = document.getElementById('quizTitle');

        const TOTAL_QUESTIONS_PER_QUIZ = 10;

        // --- Unit Definitions ---
        // Factors represent how many of the BASE unit (mg, ml, cm) are in the given unit.
        // Example: 'g': 1000 means 1 gram = 1000 mg (if mg is base)
        const unitConversions = {
            'mass': {
                'kg': 1000000, 'g': 1000, 'mg': 1, 'mcg': 0.001, 'ng': 0.000001
            },
            'volume': {
                'l': 1000, 'ml': 1, 'mcL': 0.001, 'nl': 0.000001
            },
            'length': {
                'km': 100000, 'm': 100, 'cm': 1, 'mm': 0.1, 'nm': 0.0000001
            }
        };

        // --- Helper Functions ---

        function getRandomInt(min, max) {
            return Math.floor(Math.random() * (max - min + 1)) + min;
        }

        function getRandomDecimal(min, max, decimalPlaces) {
            const factor = Math.pow(10, decimalPlaces);
            return (Math.floor(Math.random() * (max * factor - min * factor + 1)) + min * factor) / factor;
        }

        // Helper to format numbers for display (keeps necessary precision, removes unnecessary trailing zeros)
        function formatNumberForDisplay(num, maxDecimalPlaces = 3) {
            if (num === null || !isFinite(num)) return '';
            let formatted = num.toFixed(maxDecimalPlaces);
            return parseFloat(formatted).toString();
        }

        // Helper to check if a number is "clean" (whole or limited decimals)
        function isNumberClean(num, maxAllowedDecimals) {
            if (num === null || !isFinite(num)) return false;
            if (num % 1 === 0) return true; // It's a whole number

            const roundedNum = parseFloat(num.toFixed(maxAllowedDecimals));
            return Math.abs(num - roundedNum) < 1e-9; // Use a small tolerance for floating point comparison
        }


        // --- Generic Unit Conversion Helper ---
        // Converts a value from 'fromUnit' to 'toUnit' within a given 'unitType'.
        // The factors in unitConversions represent how many of the *base unit* are in the *named unit*.
        // Example: 'g': 1000 means 1g = 1000mg.
        function convertValue(value, fromUnit, toUnit, unitType) {
            const fromFactor = unitConversions[unitType][fromUnit];
            const toFactor = unitConversions[unitType][toUnit];
            if (fromFactor === undefined || toFactor === undefined) {
                console.error(`Conversion error: Invalid units ${fromUnit} or ${toUnit} for type ${unitType}`);
                return null;
            }
            // Convert 'value' from 'fromUnit' to the base unit (e.g., mg for mass)
            const valueInBaseUnit = value * fromFactor;
            // Convert 'valueInBaseUnit' from base unit to 'toUnit'
            const convertedValue = valueInBaseUnit / toFactor;

            return convertedValue;
        }


        // --- Question Generation Functions (Topic Specific) ---

        const questionGenerators = {
            'unit_conversion': function() {
                let questionData = null;
                let attempts = 0;
                const MAX_ATTEMPTS = 300;

                const unitTypes = ['mass', 'volume', 'length'];

                // Define preferred max decimal places for *any number* appearing in a specific unit,
                // whether it's in the question or the answer.
                const unitDecimalCleanliness = {
                    'kg': 2, 'g': 3, 'mg': 0, 'mcg': 0, 'ng': 0,
                    'l': 2, 'ml': 0, 'mcL': 0, 'nl': 0,
                    'km': 2, 'm': 0, 'cm': 0, 'mm': 0, 'nm': 0
                };

                // Define sensible ranges for *answers* for each unit.
                // These ranges are for the final "clean" answer value.
                const answerRanges = {
                    'mass': {
                        'kg': { min: 0.01, max: 100 }, 'g': { min: 0.1, max: 10000 }, 'mg': { min: 1, max: 50000 }, 'mcg': { min: 10, max: 100000 }
                    },
                    'volume': {
                        'l': { min: 0.01, max: 50 }, 'ml': { min: 0.1, max: 10000 }, 'mcL': { min: 1, max: 50000 }
                    },
                    'length': {
                        'km': { min: 0.01, max: 10 }, 'm': { min: 0.1, max: 5000 }, 'cm': { min: 1, max: 1000 }, 'mm': { min: 1, max: 500 }
                    }
                };

                while (questionData === null && attempts < MAX_ATTEMPTS) {
                    attempts++;
                    const selectedType = unitTypes[getRandomInt(0, unitTypes.length - 1)];
                    const units = Object.keys(unitConversions[selectedType]);

                    let fromUnit, toUnit;
                    do {
                        fromUnit = units[getRandomInt(0, units.length - 1)];
                        toUnit = units[getRandomInt(0, units.length - 1)];
                    } while (fromUnit === toUnit);

                    const ansMaxDecimals = unitDecimalCleanliness[toUnit]; // Max decimals for the answer
                    const qMaxDecimals = unitDecimalCleanliness[fromUnit]; // Max decimals for the question value

                    const currentAnswerRange = answerRanges[selectedType][toUnit];
                    if (!currentAnswerRange) continue;

                    // 1. Generate a random *answer* value, rounded to its preferred cleanliness
                    let correctAnswerNumerical;
                    if (ansMaxDecimals === 0) {
                        correctAnswerNumerical = getRandomInt(currentAnswerRange.min, currentAnswerRange.max);
                    } else {
                        // Generate a random integer and divide by a power of 10 to get desired decimal places
                        const factor = Math.pow(10, ansMaxDecimals);
                        correctAnswerNumerical = getRandomInt(currentAnswerRange.min * factor, currentAnswerRange.max * factor) / factor;
                    }

                    // Ensure the generated answer is truly clean at its max decimal places
                    if (!isNumberClean(correctAnswerNumerical, ansMaxDecimals)) {
                        continue;
                    }

                    // 2. Reverse-calculate the question's numerical value
                    const baseValueNumerical = convertValue(correctAnswerNumerical, toUnit, fromUnit, selectedType);

                    // 3. Validate that the question's numerical value is also "clean" and sensible
                    if (baseValueNumerical !== null && isFinite(baseValueNumerical) &&
                        isNumberClean(baseValueNumerical, qMaxDecimals) && // Validate against question's preferred decimals
                        baseValueNumerical > 0.00001 && baseValueNumerical < 1000000000) { // Avoid extremely small/large numbers
                        // Ensure the question value is not just 0 or extremely close to 0 after rounding
                        if (parseFloat(baseValueNumerical.toFixed(qMaxDecimals)) === 0 && baseValueNumerical !== 0) continue;

                        const formattedBaseValueDisplay = formatNumberForDisplay(baseValueNumerical, qMaxDecimals);

                        questionData = {
                            question: `What is <strong>${formattedBaseValueDisplay} ${fromUnit}</strong> expressed in ${toUnit}?`,
                            correctAnswer: correctAnswerNumerical, // Store the precise, clean numerical value
                            units: toUnit,
                            explanation: "", // No longer used for display
                            internalAnswerUnit: toUnit,
                            answerDisplayDecimals: ansMaxDecimals // For formatting the correct answer in feedback
                        };
                    }
                }

                if (questionData === null) {
                    console.warn("Failed to generate a sensible unit conversion question after multiple attempts.");
                    return {
                        question: "Could not generate a sensible unit conversion question. Please try again.",
                        correctAnswer: 0,
                        units: "",
                        explanation: "",
                        internalAnswerUnit: "",
                        answerDisplayDecimals: 0
                    };
                }

                return questionData;
            },

            'concentration_conversion': function() {
                let questionData = null;
                let attempts = 0;
                const MAX_ATTEMPTS = 200;

                const unitDecimalCleanliness = {
                    '%w/v': 1, // %w/v usually 1 decimal
                    'mg/mL': 1, // mg/mL usually 1 decimal
                    '1 in X': 1 // X value can be 1 decimal (e.g., 1 in 12.5)
                };

                const concentrationRules = [
                    // %w/v to mg/mL (multiply by 10)
                    {
                        type: '%w/v_to_mg/ml',
                        questionUnitDisplay: '%w/v',
                        answerUnitDisplay: 'mg/mL',
                        internalAnswerUnit: 'mg/mL',
                        answerRange: { min: 1, max: 800 }, // Answer (mg/mL) range
                        generate: (ansDec, qDec) => {
                            let aVal;
                            if (ansDec === 0) aVal = getRandomInt(this.answerRange.min, this.answerRange.max);
                            else aVal = getRandomDecimal(this.answerRange.min, this.answerRange.max, ansDec);

                            const qVal = aVal / 10;
                            return { questionValue: qVal, correctAnswer: aVal };
                        }
                    },
                    // mg/mL to %w/v (divide by 10)
                    {
                        type: 'mg/ml_to_%w/v',
                        questionUnitDisplay: 'mg/mL',
                        answerUnitDisplay: '%w/v',
                        internalAnswerUnit: '%w/v',
                        answerRange: { min: 0.1, max: 20.0 }, // Answer (%w/v) range
                        generate: (ansDec, qDec) => {
                            let aVal;
                            if (ansDec === 0) aVal = getRandomInt(this.answerRange.min, this.answerRange.max);
                            else aVal = getRandomDecimal(this.answerRange.min, this.answerRange.max, ansDec);

                            const qVal = aVal * 10;
                            return { questionValue: qVal, correctAnswer: aVal };
                        }
                    },
                    // 1 in X to mg/mL (1000 / X)
                    {
                        type: '1_in_X_to_mg/ml',
                        questionUnitDisplay: '1 in X',
                        answerUnitDisplay: 'mg/mL',
                        internalAnswerUnit: 'mg/mL',
                        answerRange: { min: 1, max: 1000 }, // Answer (mg/mL) range
                        generate: (ansDec, qDec) => {
                            let aVal;
                            if (ansDec === 0) aVal = getRandomInt(this.answerRange.min, this.answerRange.max);
                            else aVal = getRandomDecimal(this.answerRange.min, this.answerRange.max, ansDec);

                            const qVal = 1000 / aVal;
                            return { questionValue: qVal, correctAnswer: aVal };
                        }
                    },
                    // mg/mL to 1 in X (1000 / mg/mL)
                    {
                        type: 'mg/ml_to_1_in_X',
                        questionUnitDisplay: 'mg/mL',
                        answerUnitDisplay: '', // No unit in input box
                        internalAnswerUnit: 'ratio_X',
                        answerRange: { min: 1, max: 1000 }, // Answer (X value) range
                        generate: (ansDec, qDec) => {
                            let aVal;
                            if (ansDec === 0) aVal = getRandomInt(this.answerRange.min, this.answerRange.max);
                            else aVal = getRandomDecimal(this.answerRange.min, this.answerRange.max, ansDec);

                            const qVal = 1000 / aVal;
                            return { questionValue: qVal, correctAnswer: aVal };
                        }
                    },
                    // Dose & Volume to Concentration (mg/mL)
                    {
                        type: 'dose_volume_to_concentration',
                        questionUnitDisplay: '', // Not applicable directly
                        answerUnitDisplay: 'mg/mL',
                        internalAnswerUnit: 'mg/mL',
                        answerRange: { min: 0.1, max: 20.0 }, // Concentration answer range
                        doseRange: { min: 10, max: 10000 },
                        volumeRange: { min: 10, max: 500 },
                        generate: (ansDec, qDec) => { // qDec here for dose/volume display decimals
                            let concentration;
                            if (ansDec === 0) concentration = getRandomInt(this.answerRange.min, this.answerRange.max);
                            else concentration = getRandomDecimal(this.answerRange.min, this.answerRange.max, ansDec);

                            const volume = getRandomInt(this.volumeRange.min, this.volumeRange.max);
                            const dose = concentration * volume;

                            if (isNumberClean(dose, qDec) && isNumberClean(volume, qDec) &&
                                dose >= this.doseRange.min && dose <= this.doseRange.max) {
                                return { questionDose: dose, questionVolume: volume, correctAnswer: concentration };
                            }
                            return null;
                        }
                    }
                ];

                while (questionData === null && attempts < MAX_ATTEMPTS) {
                    attempts++;
                    const rule = concentrationRules[getRandomInt(0, concentrationRules.length - 1)];

                    // Determine decimal places for this specific question/answer pair
                    const answerDecimalPlaces = unitDecimalCleanliness[rule.answerUnitDisplay || rule.internalAnswerUnit];
                    const questionDisplayDecimals = unitDecimalCleanliness[rule.questionUnitDisplay || 'mg/mL']; // Default for dose/volume Q

                    const generatedValues = rule.generate.call(rule, answerDecimalPlaces, questionDisplayDecimals);

                    if (generatedValues === null) {
                        continue;
                    }

                    let correctAnswerNumerical = generatedValues.correctAnswer;
                    let isSensible = true;

                    // Validate cleanliness of generated answer
                    if (!isNumberClean(correctAnswerNumerical, answerDecimalPlaces)) {
                        isSensible = false;
                    }

                    // Validate cleanliness of question values
                    if (isSensible) {
                        if (rule.type === 'dose_volume_to_concentration') {
                            if (!isNumberClean(generatedValues.questionDose, questionDisplayDecimals) ||
                                !isNumberClean(generatedValues.questionVolume, questionDisplayDecimals)) {
                                isSensible = false;
                            }
                        } else {
                            if (!isNumberClean(generatedValues.questionValue, questionDisplayDecimals)) {
                                isSensible = false;
                            }
                        }
                    }

                    if (isSensible) {
                        let questionText;
                        if (rule.type === 'dose_volume_to_concentration') {
                            const formattedDose = formatNumberForDisplay(generatedValues.questionDose, questionDisplayDecimals);
                            const formattedVolume = formatNumberForDisplay(generatedValues.questionVolume, questionDisplayDecimals);
                            questionText = `If <strong>${formattedDose} mg</strong> of a drug is dissolved in <strong>${formattedVolume} ml</strong> of solution, what is the concentration in <strong>mg/mL</strong>?`;
                        } else {
                            const formattedQuestionValue = formatNumberForDisplay(generatedValues.questionValue, questionDisplayDecimals);
                            if (rule.questionUnitDisplay === '1 in X') {
                                questionText = `What is <strong>1 in ${formattedQuestionValue}</strong> expressed as ${rule.answerUnitDisplay}?`;
                            } else if (rule.questionUnitDisplay === 'mg/mL' && rule.internalAnswerUnit === 'ratio_X') {
                                questionText = `What is <strong>${formattedQuestionValue} mg/mL</strong> expressed as 1 in X? Enter the value of X.`;
                            } else {
                                questionText = `What is <strong>${formattedQuestionValue} ${rule.questionUnitDisplay}</strong> expressed as ${rule.answerUnitDisplay}?`;
                            }
                        }

                        questionData = {
                            question: questionText,
                            correctAnswer: correctAnswerNumerical,
                            units: rule.answerUnitDisplay,
                            internalAnswerUnit: rule.internalAnswerUnit,
                            answerDisplayDecimals: answerDecimalPlaces, // Use the randomly chosen answer decimals
                            explanation: "" // No longer used for display
                        };
                    }
                }

                if (questionData === null) {
                    console.warn("Failed to generate a sensible concentration conversion question after multiple attempts.");
                    return {
                        question: "Could not generate a sensible concentration conversion question. Please try again.",
                        correctAnswer: 0,
                        units: "",
                        explanation: "",
                        internalAnswerUnit: "",
                        answerDisplayDecimals: 0
                    };
                }
                return questionData;
            },

            'dosage_volume': function() {
                let questionData = null;
                let attempts = 0;
                const MAX_ATTEMPTS = 200;

                const unitDecimalCleanliness = {
                    'mg': 0, 'g': 2, // mg usually whole, g can have 2 decimals
                    'ml': 0, // ml usually whole
                    '%w/w': 1, '%w/v': 1 // Percentages usually 1 decimal
                };

                const dosageVolumeRules = [
                    // Calculate Dose: Concentration (mg/mL) x Volume (mL) = Dose (mg)
                    {
                        type: 'calculate_dose',
                        answerUnitDisplay: 'mg',
                        internalAnswerUnit: 'mg',
                        answerRange: { min: 1, max: 10000 }, // Dose (mg) range
                        generate: (ansDec, qConcDec, qVolDec) => {
                            let dose;
                            if (ansDec === 0) dose = getRandomInt(this.answerRange.min, this.answerRange.max);
                            else dose = getRandomDecimal(this.answerRange.min, this.answerRange.max, ansDec);

                            const conc = getRandomDecimal(0.1, 100.0, qConcDec); // Generate a clean concentration
                            if (conc === 0) return null;
                            const vol = dose / conc; // Calculate volume

                            if (isNumberClean(vol, qVolDec) && isNumberClean(conc, qConcDec) &&
                                vol >= 1 && vol <= 500) { // Volume is clean and sensible
                                return { questionConcentration: conc, questionVolume: vol, correctAnswer: dose };
                            }
                            return null;
                        }
                    },
                    // Calculate Volume: Dose (mg) / Concentration (mg/mL) = Volume (mL)
                    {
                        type: 'calculate_volume',
                        answerUnitDisplay: 'ml',
                        internalAnswerUnit: 'ml',
                        answerRange: { min: 0.1, max: 500 }, // Volume (ml) range
                        generate: (ansDec, qDoseDec, qConcDec) => {
                            let vol;
                            if (ansDec === 0) vol = getRandomInt(this.answerRange.min, this.answerRange.max);
                            else vol = getRandomDecimal(this.answerRange.min, this.answerRange.max, ansDec);
                            if (vol === 0) return null;

                            const conc = getRandomDecimal(0.1, 100.0, qConcDec);
                            if (conc === 0) return null;

                            const dose = conc * vol;

                            if (isNumberClean(dose, qDoseDec) && isNumberClean(conc, qConcDec) &&
                                dose >= 10 && dose <= 10000) { // Dose is clean and sensible
                                return { questionDose: dose, questionConcentration: conc, correctAnswer: vol };
                            }
                            return null;
                        }
                    },
                    // Cream %w/w to Active Ingredient (g or mg)
                    {
                        type: 'calculate_w_w_ingredient',
                        answerUnitDisplay: (ans) => ans < 1 ? 'mg' : 'g',
                        internalAnswerUnit: 'dynamic_mass',
                        answerRange: { min: 0.001, max: 50 }, // Active ingredient in grams
                        generate: (ansDec, qPercentDec, qTotalGDec) => {
                            let active_ingredient_g;
                            if (ansDec === 0) active_ingredient_g = getRandomInt(this.answerRange.min, this.answerRange.max);
                            else active_ingredient_g = getRandomDecimal(this.answerRange.min, this.answerRange.max, ansDec);
                            if (active_ingredient_g === 0) return null;

                            const total_g = getRandomDecimal(10, 500, qTotalGDec); // Total cream in grams
                            if (total_g === 0) return null;

                            const percent_ww = (active_ingredient_g / total_g) * 100;

                            if (isNumberClean(percent_ww, qPercentDec) && isNumberClean(total_g, qTotalGDec) &&
                                percent_ww >= 0.1 && percent_ww <= 20.0) { // Percent is clean and sensible
                                return { questionPercentWW: percent_ww, questionTotalG: total_g, correctAnswer: active_ingredient_g };
                            }
                            return null;
                        }
                    },
                    // Volume from Dose (mg or g) and %w/v solution
                    {
                        type: 'calculate_volume_from_dose_and_percent_solution',
                        answerUnitDisplay: 'ml',
                        internalAnswerUnit: 'ml',
                        answerRange: { min: 0.1, max: 500 }, // Volume (ml) range
                        generate: (ansDec, qDoseValDec, qPercentWVDec) => {
                            let volume_needed;
                            if (ansDec === 0) volume_needed = getRandomInt(this.answerRange.min, this.answerRange.max);
                            else volume_needed = getRandomDecimal(this.answerRange.min, this.answerRange.max, ansDec);
                            if (volume_needed === 0) return null;

                            const percent_wv = getRandomDecimal(0.1, 10.0, qPercentWVDec);
                            if (percent_wv === 0) return null;

                            const have_mg_in_100ml = percent_wv * 1000;
                            let required_dose_mg = (volume_needed / 100) * have_mg_in_100ml;

                            let questionDoseUnit = 'mg';
                            let questionDoseValue = required_dose_mg;

                            // Decide if dose should be presented in grams or milligrams, and ensure cleanliness
                            if (required_dose_mg >= 1000 && Math.random() < 0.5) {
                                questionDoseUnit = 'g';
                                questionDoseValue = required_dose_mg / 1000;
                            }

                            if (isNumberClean(questionDoseValue, qDoseValDec) && isNumberClean(percent_wv, qPercentWVDec) &&
                                questionDoseValue >= (questionDoseUnit === 'mg' ? 10 : 0.01) &&
                                questionDoseValue <= (questionDoseUnit === 'mg' ? 10000 : 10)) { // Sensible range for dose
                                return {
                                    questionDoseValue: questionDoseValue,
                                    questionDoseUnit: questionDoseUnit,
                                    questionPercentWV: percent_wv,
                                    correctAnswer: volume_needed
                                };
                            }
                            return null;
                        }
                    }
                ];

                while (questionData === null && attempts < MAX_ATTEMPTS) {
                    attempts++;
                    const rule = dosageVolumeRules[getRandomInt(0, dosageVolumeRules.length - 1)];

                    // Determine decimal places for this specific question/answer pair
                    const answerDecimalPlaces = typeof rule.answerDecimals === 'function' ?
                        rule.answerDecimals(rule.answerRange.min)[getRandomInt(0, rule.answerDecimals(rule.answerRange.min).length - 1)] :
                        rule.answerDecimals[getRandomInt(0, rule.answerDecimals.length - 1)];

                    // Determine question display decimals based on the type of values in the question
                    let qValDecimals = [];
                    if (rule.type === 'calculate_dose') {
                        qValDecimals = [unitDecimalCleanliness['mg/mL'], unitDecimalCleanliness['ml']]; // Conc, Vol
                    } else if (rule.type === 'calculate_volume') {
                        qValDecimals = [unitDecimalCleanliness['mg'], unitDecimalCleanliness['mg/mL']]; // Dose, Conc
                    } else if (rule.type === 'calculate_w_w_ingredient') {
                        qValDecimals = [unitDecimalCleanliness['%w/w'], unitDecimalCleanliness['g']]; // Percent, Total G
                    } else if (rule.type === 'calculate_volume_from_dose_and_percent_solution') {
                        qValDecimals = [unitDecimalCleanliness['mg'], unitDecimalCleanliness['%w/v']]; // Dose, Percent
                    }

                    const generatedValues = rule.generate.apply(rule, [answerDecimalPlaces, ...qValDecimals]);

                    if (generatedValues === null) {
                        continue;
                    }

                    let correctAnswerNumerical = generatedValues.correctAnswer;
                    let isSensible = true;

                    // Validate cleanliness of generated answer
                    if (!isNumberClean(correctAnswerNumerical, answerDecimalPlaces)) {
                        isSensible = false;
                    }

                    // Validate cleanliness of question values
                    if (isSensible) {
                        if (rule.type === 'calculate_dose') {
                            if (!isNumberClean(generatedValues.questionConcentration, qValDecimals[0]) ||
                                !isNumberClean(generatedValues.questionVolume, qValDecimals[1])) {
                                isSensible = false;
                            }
                        } else if (rule.type === 'calculate_volume') {
                            if (!isNumberClean(generatedValues.questionDose, qValDecimals[0]) ||
                                !isNumberClean(generatedValues.questionConcentration, qValDecimals[1])) {
                                isSensible = false;
                            }
                        } else if (rule.type === 'calculate_w_w_ingredient') {
                            if (!isNumberClean(generatedValues.questionPercentWW, qValDecimals[0]) ||
                                !isNumberClean(generatedValues.questionTotalG, qValDecimals[1])) {
                                isSensible = false;
                            }
                        } else if (rule.type === 'calculate_volume_from_dose_and_percent_solution') {
                            if (!isNumberClean(generatedValues.questionDoseValue, qValDecimals[0]) ||
                                !isNumberClean(generatedValues.questionPercentWV, qValDecimals[1])) {
                                isSensible = false;
                            }
                        }
                    }

                    if (isSensible) {
                        let questionText;

                        const answerUnit = typeof rule.answerUnitDisplay === 'function' ? rule.answerUnitDisplay(correctAnswerNumerical) : rule.answerUnitDisplay;

                        // Construct question text based on the rule type and generated values
                        if (rule.type === 'calculate_dose') {
                            questionText = `If a solution has a concentration of <strong>${formatNumberForDisplay(generatedValues.questionConcentration, qValDecimals[0])} mg/mL</strong>, how many milligrams of drug are in <strong>${formatNumberForDisplay(generatedValues.questionVolume, qValDecimals[1])} ml</strong> of this solution?`;
                        } else if (rule.type === 'calculate_volume') {
                            questionText = `How many millilitres of a solution with a concentration of <strong>${formatNumberForDisplay(generatedValues.questionConcentration, qValDecimals[1])} mg/mL</strong> would be required to provide a dose of <strong>${formatNumberForDisplay(generatedValues.questionDose, qValDecimals[0])} mg</strong>?`;
                        } else if (rule.type === 'calculate_w_w_ingredient') {
                            questionText = `A cream is described as <strong>${formatNumberForDisplay(generatedValues.questionPercentWW, qValDecimals[0])}% w/w</strong>. How much active ingredient is there in <strong>${formatNumberForDisplay(generatedValues.questionTotalG, qValDecimals[1])} g</strong> of this cream?`;
                        } else if (rule.type === 'calculate_volume_from_dose_and_percent_solution') {
                            questionText = `How many ml of solution are required to provide a dose of <strong>${formatNumberForDisplay(generatedValues.questionDoseValue, qValDecimals[0])} ${generatedValues.questionDoseUnit}</strong> from a <strong>${formatNumberForDisplay(generatedValues.questionPercentWV, qValDecimals[1])}% w/v</strong> solution?`;
                        }

                        questionData = {
                            question: questionText,
                            correctAnswer: correctAnswerNumerical,
                            units: answerUnit,
                            internalAnswerUnit: rule.internalAnswerUnit,
                            answerDisplayDecimals: answerDecimalPlaces,
                            explanation: "" // No longer used for display
                        };
                    }
                }

                if (questionData === null) {
                    console.warn("Failed to generate a sensible dosage & volume question after multiple attempts.");
                    return {
                        question: "Could not generate a sensible dosage & volume question. Please try again.",
                        correctAnswer: 0,
                        units: "",
                        explanation: "",
                        internalAnswerUnit: "",
                        answerDisplayDecimals: 0
                    };
                }
                return questionData;
            }
        };

        // --- Core Quiz Logic ---

        function startQuiz(topicId) {
            selectedTopicId = topicId; // Store the topic ID
            const selectedTopicGenerator = questionGenerators[topicId];
            if (typeof selectedTopicGenerator !== 'function') { // More robust check
                alert('Invalid topic selected or generator not found!');
                console.error("Generator for topic '" + topicId + "' is not a function:", selectedTopicGenerator);
                return;
            }

            currentQuizQuestions = [];
            for (let i = 0; i < TOTAL_QUESTIONS_PER_QUIZ; i++) {
                try {
                    currentQuizQuestions.push(selectedTopicGenerator());
                } catch (e) {
                    console.error(`Error generating question for topic ${topicId}:`, e);
                    alert(`Error generating question for this topic. Please try another topic or refresh. Details: ${e.message}`);
                    return;
                }
            }

            currentQuestionIndex = 0;
            score = 0;
            secondsElapsed = 0;
            scoreTracker.textContent = score;
            totalQuestionsSpan.textContent = TOTAL_QUESTIONS_PER_QUIZ;
            quizTitle.textContent = formatTopicTitle(topicId);

            topicSelectionDiv.style.display = 'none';
            quizSummaryDiv.style.display = 'none';
            quizSectionDiv.style.display = 'block';

            restartQuizBtn.style.display = 'none';
            checkAnswerBtn.style.display = 'inline-block';
            nextQuestionBtn.style.display = 'inline-block';
            checkAnswerBtn.disabled = false;
            nextQuestionBtn.disabled = true;
            userAnswerInput.value = '';
            userAnswerInput.disabled = false;

            startTimer();
            displayQuestion();
        }

        function displayQuestion() {
            if (currentQuestionIndex >= currentQuizQuestions.length) {
                endQuiz();
                return;
            }

            const question = currentQuizQuestions[currentQuestionIndex];
            currentQuestionNum.textContent = currentQuestionIndex + 1;
            questionText.innerHTML = question.question;
            userAnswerInput.value = '';
            userAnswerInput.disabled = false;
            answerUnitDisplay.textContent = question.units;
            feedbackMessage.style.display = 'none';
            solutionExplanation.style.display = 'none'; // Ensure solution explanation is hidden
            feedbackMessage.className = 'feedback-message';

            if (window.MathJax) {
                MathJax.typesetPromise([questionText]).catch((err) => console.error("MathJax typesetting error:", err));
            }

            checkAnswerBtn.disabled = false;
            nextQuestionBtn.disabled = true;
            userAnswerInput.focus();
        }

        function checkAnswer() {
            const userAnswerRaw = userAnswerInput.value;
            let userAnswer = parseFloat(userAnswerRaw);

            if (isNaN(userAnswer)) {
                feedbackMessage.textContent = "Please enter a numerical answer.";
                feedbackMessage.className = 'feedback-message feedback-incorrect';
                feedbackMessage.style.display = 'block';
                return;
            }

            const currentQuestion = currentQuizQuestions[currentQuestionIndex];
            const correctAnswer = currentQuestion.correctAnswer; // This is the precise, clean numerical value

            // Determine the correct number of decimal places for comparison based on the question's rule
            const answerDecimalsForComparison = typeof currentQuestion.answerDisplayDecimals === 'function' ?
                currentQuestion.answerDisplayDecimals(correctAnswer) : currentQuestion.answerDisplayDecimals;

            // Format the precise correct answer to its intended display decimals for comparison
            const formattedCorrectAnswerForComparison = parseFloat(correctAnswer.toFixed(answerDecimalsForComparison));

            // Round user answer to the same number of decimal places for a fair comparison
            userAnswer = parseFloat(userAnswer.toFixed(answerDecimalsForComparison));


            console.log("User Input Raw:", userAnswerRaw);
            console.log("Parsed & Normalized User Answer:", userAnswer);
            console.log("Correct Answer Numerical (Precise):", correctAnswer);
            console.log("Correct Answer Numerical (Formatted for Comparison):", formattedCorrectAnswerForComparison);

            console.log("Absolute difference (User vs Formatted Correct):", Math.abs(userAnswer - formattedCorrectAnswerForComparison));
            const tolerance = 0.00001; // Increased tolerance for floating point comparison issues
            console.log("Tolerance:", tolerance);
            console.log("Is within tolerance:", Math.abs(userAnswer - formattedCorrectAnswerForComparison) < tolerance);


            // Compare the user's rounded answer with the precisely calculated answer, rounded to the display decimals.
            if (Math.abs(userAnswer - formattedCorrectAnswerForComparison) < tolerance) {
                score++;
                feedbackMessage.textContent = "Correct!";
                feedbackMessage.className = 'feedback-message feedback-correct';
            } else {
                let feedbackAnswerDisplayString;
                // Format the precise correct answer for display in the feedback message
                if (currentQuestion.internalAnswerUnit === 'ratio_X') {
                    feedbackAnswerDisplayString = `1 in ${formatNumberForDisplay(correctAnswer, answerDecimalsForComparison)}`;
                } else if (currentQuestion.internalAnswerUnit === 'dynamic_mass') {
                    const unit = typeof currentQuestion.units === 'function' ? currentQuestion.units(correctAnswer) : currentQuestion.units;
                    const decimals = typeof currentQuestion.answerDisplayDecimals === 'function' ? currentQuestion.answerDisplayDecimals(correctAnswer) : currentQuestion.answerDisplayDecimals;
                    feedbackAnswerDisplayString = `${formatNumberForDisplay(correctAnswer * (unit === 'mg' ? 1000 : 1), decimals)} ${unit}`;
                }
                else {
                    feedbackAnswerDisplayString = `${formatNumberForDisplay(correctAnswer, answerDecimalsForComparison)} ${currentQuestion.units}`;
                }

                feedbackMessage.textContent = `Incorrect. The correct answer was ${feedbackAnswerDisplayString}.`;
                feedbackMessage.className = 'feedback-message feedback-incorrect';
            }

            scoreTracker.textContent = score;
            feedbackMessage.style.display = 'block';
            solutionExplanation.style.display = 'none'; // Explicitly ensure solution explanation is hidden

            checkAnswerBtn.disabled = true;
            nextQuestionBtn.disabled = false;
            userAnswerInput.disabled = true;
        }

        function nextQuestion() {
            currentQuestionIndex++;
            displayQuestion();
        }

        function endQuiz() {
                clearInterval(timerInterval);
                quizSummaryDiv.style.display = 'block';
                quizSectionDiv.style.display = 'none';

                document.getElementById('finalScore').textContent = score;
                document.getElementById('finalTotal').textContent = TOTAL_QUESTIONS_PER_QUIZ;
                document.getElementById('finalTime').textContent = formatTime(secondsElapsed);
            }

            function startTimer() {
                clearInterval(timerInterval);
                secondsElapsed = 0;
                timeTracker.textContent = formatTime(secondsElapsed);
                timerInterval = setInterval(() => {
                    secondsElapsed++;
                    timeTracker.textContent = formatTime(secondsElapsed);
                }, 1000);
            }

            function formatTime(totalSeconds) {
                const minutes = Math.floor(totalSeconds / 60);
                const remainingSeconds = totalSeconds % 60;
                return `${minutes} minute${minutes === 1 ? '' : 's'} ${remainingSeconds} second${remainingSeconds === 1 ? '' : 's'}`;
            }

            function formatTopicTitle(topicId) {
                return topicId.replace(/_/g, ' ').replace(/\b\w/g, char => char.toUpperCase()) + ' Questions';
            }

            // --- Event Listeners ---

            // Topic selection buttons
            document.querySelectorAll('.topic-button').forEach(button => {
                button.addEventListener('click', (event) => {
                    const topic = event.currentTarget.dataset.topic;
                    startQuiz(topic);
                });
            });

            checkAnswerBtn.addEventListener('click', checkAnswer);
            nextQuestionBtn.addEventListener('click', nextQuestion);
            // Use selectedTopicId for restarting the quiz
            restartQuizBtn.addEventListener('click', () => startQuiz(selectedTopicId));
            summaryRestartBtn.addEventListener('click', () => startQuiz(selectedTopicId));

            backToTopicsBtn.addEventListener('click', () => {
                quizSummaryDiv.style.display = 'none';
                topicSelectionDiv.style.display = 'block';
                quizTitle.textContent = 'Random Questions'; // Reset navbar title
            });

            // Allow pressing Enter to check answer or move to next question
            userAnswerInput.addEventListener('keypress', (event) => {
                if (event.key === 'Enter') {
                    if (!checkAnswerBtn.disabled) {
                        checkAnswer();
                    } else if (!nextQuestionBtn.disabled) {
                        nextQuestion();
                    }
                }
            });

            // --- Initial Setup ---
            window.onload = () => {
                // Ensure topic selection is visible at start
                topicSelectionDiv.style.display = 'block';
                quizSectionDiv.style.display = 'none';
                quizSummaryDiv.style.display = 'none';
            };

        </script>
    </body>
    </html>
