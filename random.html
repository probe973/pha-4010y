<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Random Pharmacy Questions</title>
    <link rel="stylesheet" href="assets/css/style.css">
    <link rel="icon" href="/pha-4010y/favicon.ico" type="image/x-icon">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <script type="text/javascript" id="MathJax-script">
        // MathJax is still loaded for potential future use or if questions themselves have math,
        // but solution explanations will no longer use it.
        window.MathJax = {
            tex: {
                inlineMath: [['$', '$'], ['\\(', '\\)']]
            },
            options: {
                // Removed 'scale' option here to rely on CSS 'font-size: 1em !important;' from style.css
            },
            svg: {
                fontCache: 'global'
            }
        };
    </script>
    <script type="text/javascript" id="MathJax-script"
        src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js">
    </script>
</head>
<body>

    <div class="navbar">
        <a href="index.html" class="navbar-link">Home</a>
        <span class="navbar-title" id="quizTitle">Random Questions</span>
    </div>

    <div class="content">
        <h1>Generate Practice Questions</h1>

        <!-- Topic Selection Section -->
        <div id="topicSelection" class="quiz-container">
            <h2>Select a Topic</h2>
            <p>Choose a topic to generate 10 random questions.</p>
            <div class="topic-link-container">
                <button class="topic-button" data-topic="unit_conversion">
                    <i class="fas fa-ruler-combined topic-icon"></i> Unit Conversions
                </button>
                <button class="topic-button" data-topic="concentration_conversion">
                    <i class="fas fa-flask topic-icon"></i> Concentration Conversions
                </button>
                <button class="topic-button" data-topic="dosage_volume">
                    <i class="fas fa-pills topic-icon"></i> Dosage & Volume
                </button>
                <!-- Other topic buttons are still removed for now -->
            </div>
        </div>

        <!-- Quiz Section (hidden initially) -->
        <div id="quizSection" style="display: none;">
            <div class="status-bar">
                <span>Question: <span id="currentQuestionNum">1</span> / <span id="totalQuestions">10</span></span>
                <span>Score: <span id="scoreTracker">0</span></span>
                <span>Time: <span id="timeTracker">0 minutes</span></span>
            </div>

            <div class="quiz-container">
                <p class="question-number" id="questionNumberDisplay"></p>
                <p class="question-text" id="questionText"></p>
                <div class="answer-input-container">
                    <input type="text" id="userAnswerInput" placeholder="Enter your answer" class="text-input">
                    <span id="answerUnitDisplay" class="unit-display"></span>
                </div>

                <div class="feedback-message" id="feedbackMessage"></div>
                <!-- Solution explanation div is hidden and will not be populated -->
                <div class="solution-explanation" id="solutionExplanation" style="display: none;"></div>

                <div class="button-group">
                    <button id="checkAnswerBtn">Check Answer</button>
                    <button id="nextQuestionBtn" disabled>Next Question</button>
                    <button id="restartQuizBtn" style="display: none;">Restart Quiz</button>
                </div>
            </div>
        </div>

        <!-- Quiz Summary Section (hidden initially) -->
        <div class="quiz-summary" id="quizSummary" style="display: none;">
            <h2>Quiz Complete!</h2>
            <p>Your final score: <span id="finalScore"></span> out of <span id="finalTotal"></span></p>
            <p>Time taken: <span id="finalTime"></span></p>
            <div class="button-group">
                <button id="summaryRestartBtn">Restart Quiz</button>
                <button id="backToTopicsBtn">Back to Topics</button>
            </div>
        </div>
    </div>

    <footer style="text-align: center; margin-top: 50px; padding: 20px; font-size: 0.8em; color: #666;">
        <p>Icons by <a href="https://fontawesome.com/" target="_blank" rel="noopener noreferrer">Font Awesome</a>, licensed under <a href="https://creativecommons.org/licenses/by/4.0/" target="_blank" rel="noopener noreferrer">CC BY 4.0</a>.</p>
        <p>Mathematical typesetting by <a href="https://www.mathjax.org/" target="_blank" rel="noopener noreferrer">MathJax</a>.</p>
        <p>Styled with <a href="https://tailwindcss.com/" target="_blank" rel="noopener noreferrer">Tailwind CSS</a>.</p>
    </footer>

    <script>
        let currentQuizQuestions = []; // Stores the 10 generated questions for the current quiz
        let currentQuestionIndex = 0;
        let score = 0;
        let timerInterval;
        let secondsElapsed = 0;
        let selectedTopicId = null; // Store the ID of the currently selected topic

        // UI Elements
        const topicSelectionDiv = document.getElementById('topicSelection');
        const quizSectionDiv = document.getElementById('quizSection');
        const quizSummaryDiv = document.getElementById('quizSummary');

        const questionNumberDisplay = document.getElementById('questionNumberDisplay');
        const questionText = document.getElementById('questionText');
        const userAnswerInput = document.getElementById('userAnswerInput');
        const answerUnitDisplay = document.getElementById('answerUnitDisplay');
        const feedbackMessage = document.getElementById('feedbackMessage');
        const solutionExplanation = document.getElementById('solutionExplanation'); // This will now remain hidden
        const checkAnswerBtn = document.getElementById('checkAnswerBtn');
        const nextQuestionBtn = document.getElementById('nextQuestionBtn');
        const restartQuizBtn = document.getElementById('restartQuizBtn');
        const summaryRestartBtn = document.getElementById('summaryRestartBtn');
        const backToTopicsBtn = document.getElementById('backToTopicsBtn');
        const scoreTracker = document.getElementById('scoreTracker');
        const timeTracker = document.getElementById('timeTracker');
        const currentQuestionNum = document.getElementById('currentQuestionNum');
        const totalQuestionsSpan = document.getElementById('totalQuestions'); // Total questions in this quiz (fixed at 10)
        const quizTitle = document.getElementById('quizTitle');

        const TOTAL_QUESTIONS_PER_QUIZ = 10;

        // --- Unit Definitions ---
        // Factors represent how many of the BASE unit (mg, ml, cm) are in the given unit.
        // Example: 'g': 1000 means 1 gram = 1000 mg (if mg is base)
        const unitConversions = {
            'mass': {
                'kg': 1000000, 'g': 1000, 'mg': 1, 'mcg': 0.001, 'ng': 0.000001
            },
            'volume': {
                'l': 1000, 'ml': 1, 'mcL': 0.001, 'nl': 0.000001 // mcL for microlitres (volume)
            },
            'length': {
                'km': 100000, 'm': 100, 'cm': 1, 'mm': 0.1, 'nm': 0.0000001
            }
        };

        // --- Helper Functions ---

        function getRandomInt(min, max) {
            return Math.floor(Math.random() * (max - min + 1)) + min;
        }

        function getRandomDecimal(min, max, decimalPlaces) {
            const factor = Math.pow(10, decimalPlaces);
            return (Math.floor(Math.random() * (max * factor - min * factor + 1)) + min * factor) / factor;
        }

        // Helper to format numbers for display (keeps necessary precision, removes trailing zeros)
        // E.g., formatNumberForDisplay(15, 1) -> "15" (if it's a whole number)
        // E.g., formatNumberForDisplay(15.312, 1) -> "15.3"
        // E.g., formatNumberForDisplay(0.091, 3) -> "0.091"
        // E.g., formatNumberForDisplay(1.230, 3) -> "1.23"
        function formatNumberForDisplay(num, maxDecimalPlaces = 3) {
            if (num === null || !isFinite(num)) return ''; // Handle non-finite numbers
            const fixed = num.toFixed(maxDecimalPlaces);
            // Convert to float then back to string to remove unnecessary trailing zeros (e.g., "15.0" -> "15", "1.230" -> "1.23")
            // But keep the decimal if it's significant (e.g., "0.091")
            let result = parseFloat(fixed).toString();
            // If the original number had a decimal and the fixed version still has one, ensure it's not truncated too aggressively
            if (num % 1 !== 0 && fixed.includes('.') && !result.includes('.')) {
                // This means parseFloat removed a necessary .0, so re-add if it was explicitly .0
                if (num.toFixed(1) === fixed) { // If original fixed to 1 decimal is the same as the fixed version
                     result = num.toFixed(1);
                } else {
                    result = fixed; // Fallback to fixed if complex
                }
            }
            return result;
        }


        // --- Generic Unit Conversion Helper ---
        // Converts a value from 'fromUnit' to 'toUnit' within a given 'unitType'.
        // The factors in unitConversions represent how many of the *base unit* are in the *named unit*.
        // Example: 'g': 1000 means 1g = 1000mg.
        function convertValue(value, fromUnit, toUnit, unitType) {
            const fromFactor = unitConversions[unitType][fromUnit];
            const toFactor = unitConversions[unitType][toUnit];
            if (fromFactor === undefined || toFactor === undefined) {
                console.error(`Conversion error: Invalid units ${fromUnit} or ${toUnit} for type ${unitType}`);
                return null;
            }
            // Convert 'value' from 'fromUnit' to the base unit (e.g., mg for mass)
            const valueInBaseUnit = value * fromFactor;
            // Convert 'valueInBaseUnit' from base unit to 'toUnit'
            const convertedValue = valueInBaseUnit / toFactor;

            return convertedValue;
        }


        // --- Question Generation Functions (Topic Specific) ---

        const questionGenerators = {
            'unit_conversion': function() {
                let questionData = null;
                let attempts = 0;
                const MAX_ATTEMPTS = 100; // Prevent infinite loops if generation is too strict

                // Define sensible conversion rules.
                // Each rule specifies:
                // - from: The starting unit in the question
                // - to: The target unit for the answer
                // - type: The unit category (mass, volume, length)
                // - generateAnswer: A function to produce a numerical answer that is "sensible" (e.g., whole, 1-3 decimals)
                // - answerDisplayDecimals: The maximum decimal places to show for the answer.
                const conversionRules = [
                    // Mass conversions
                    { from: 'kg', to: 'g', type: 'mass', generateAnswer: () => getRandomInt(50, 20000), answerDisplayDecimals: 0 },
                    { from: 'g', to: 'kg', type: 'mass', generateAnswer: () => getRandomDecimal(0.05, 100.0, 1), answerDisplayDecimals: 1 },
                    { from: 'g', to: 'mg', type: 'mass', generateAnswer: () => getRandomInt(5, 10000), answerDisplayDecimals: 0 },
                    { from: 'mg', to: 'g', type: 'mass', generateAnswer: () => getRandomDecimal(0.05, 1000.0, 1), answerDisplayDecimals: 1 },
                    { from: 'mg', to: 'mcg', type: 'mass', generateAnswer: () => getRandomInt(50, 50000), answerDisplayDecimals: 0 },
                    { from: 'mcg', to: 'mg', type: 'mass', generateAnswer: () => getRandomDecimal(0.05, 50.0, 1), answerDisplayDecimals: 1 },
                    // Special cases for g <-> mcg to allow 0.0XX g in question/answer if needed, but keep it sensible
                    { from: 'g', to: 'mcg', type: 'mass', generateAnswer: () => getRandomInt(500, 200000), answerDisplayDecimals: 0 }, // Answer is whole mcg. Question will be 0.0X g
                    { from: 'mcg', to: 'g', type: 'mass', generateAnswer: () => getRandomDecimal(0.0005, 0.5, 3), answerDisplayDecimals: 3 }, // Answer is 0.0XX g. Question will be whole mcg.

                    // Volume conversions
                    { from: 'l', to: 'ml', type: 'volume', generateAnswer: () => getRandomInt(10, 10000), answerDisplayDecimals: 0 },
                    { from: 'ml', to: 'l', type: 'volume', generateAnswer: () => getRandomDecimal(0.1, 10.0, 1), answerDisplayDecimals: 1 },
                    { from: 'ml', to: 'mcL', type: 'volume', generateAnswer: () => getRandomInt(100, 10000), answerDisplayDecimals: 0 },
                    { from: 'mcL', to: 'ml', type: 'volume', generateAnswer: () => getRandomDecimal(0.1, 10.0, 1), answerDisplayDecimals: 1 },

                    // Length conversions
                    { from: 'km', to: 'm', type: 'length', generateAnswer: () => getRandomInt(100, 5000), answerDisplayDecimals: 0 },
                    { from: 'm', to: 'km', type: 'length', generateAnswer: () => getRandomDecimal(0.1, 5.0, 1), answerDisplayDecimals: 1 },
                    { from: 'm', to: 'cm', type: 'length', generateAnswer: () => getRandomInt(10, 2000), answerDisplayDecimals: 0 },
                    { from: 'cm', to: 'm', type: 'length', generateAnswer: () => getRandomDecimal(0.1, 20.0, 1), answerDisplayDecimals: 1 },
                    { from: 'cm', to: 'mm', type: 'length', generateAnswer: () => getRandomInt(10, 100), answerDisplayDecimals: 0 },
                    { from: 'mm', to: 'cm', type: 'length', generateAnswer: () => getRandomDecimal(0.1, 10.0, 1), answerDisplayDecimals: 1 }
                ];

                while (questionData === null && attempts < MAX_ATTEMPTS) {
                    attempts++;
                    const rule = conversionRules[getRandomInt(0, conversionRules.length - 1)];

                    const fromUnit = rule.from;
                    const toUnit = rule.to;
                    const selectedType = rule.type;
                    const answerDisplayDecimals = rule.answerDisplayDecimals;

                    // 1. Generate a clean numerical answer based on the rule's desired precision for the answer
                    const correctAnswerNumerical = rule.generateAnswer();

                    // 2. Calculate the question's base value by reverse converting the correct answer
                    const baseValueNumerical = convertValue(correctAnswerNumerical, toUnit, fromUnit, selectedType);

                    // 3. Check if the baseValueNumerical is "sensible" for the question
                    // Sensible means: not null, not too many decimal places (max 3 for question display), not extremely large/small
                    let isBaseValueSensible = true;
                    if (baseValueNumerical === null || !isFinite(baseValueNumerical)) { // Added !isFinite check
                        isBaseValueSensible = false;
                    } else if (baseValueNumerical % 1 !== 0) { // It's a decimal
                        const decimalString = baseValueNumerical.toFixed(5).split('.')[1] || ''; // Check up to 5 fixed decimal places
                        if (decimalString.length > 3 && parseFloat(decimalString.substring(3)) !== 0) { // More than 3 significant decimal places
                            isBaseValueSensible = false;
                        }
                    }
                    // Add checks for extremely large/small values if needed, e.g., Math.abs(baseValueNumerical) > 1e6 || Math.abs(baseValueNumerical) < 1e-6

                    if (isBaseValueSensible) {
                        const formattedBaseValueDisplay = formatNumberForDisplay(baseValueNumerical, 3); // Max 3 decimals for question display
                        const formattedCorrectAnswerDisplay = formatNumberForDisplay(correctAnswerNumerical, answerDisplayDecimals); // Use rule's specific decimal places for answer display

                        // The explanation string is no longer needed for display, but we keep it here for completeness
                        // if we were to re-enable explanations in the future.
                        const conversionFactor = unitConversions[selectedType][fromUnit] / unitConversions[selectedType][toUnit];
                        let operationText;
                        let factorForExplanation;

                        if (conversionFactor >= 1) {
                            operationText = 'multiply';
                            factorForExplanation = formatNumberForDisplay(conversionFactor, 0);
                        } else {
                            operationText = 'divide';
                            factorForExplanation = formatNumberForDisplay(1 / conversionFactor, 0);
                        }

                        const explanationText = `To convert ${formattedBaseValueDisplay} ${fromUnit} to ${toUnit}, you ${operationText} by ${factorForExplanation}.`;
                        const mathJaxCalculation = `$${formattedBaseValueDisplay}~\\text{${fromUnit}} ${operationText === 'multiply' ? '\\times' : '\\div'} ${factorForExplanation} = ${formattedCorrectAnswerDisplay}~\\text{${toUnit}}$`;


                        questionData = {
                            question: `What is <strong>${formattedBaseValueDisplay} ${fromUnit}</strong> expressed in ${toUnit}?`,
                            correctAnswer: correctAnswerNumerical, // Store numerical value for comparison
                            units: toUnit,
                            // Explanation is no longer used for display
                            explanation: `${explanationText} ${mathJaxCalculation}`,
                            internalAnswerUnit: toUnit, // For feedback formatting in checkAnswer
                            answerDisplayDecimals: answerDisplayDecimals // For feedback formatting in checkAnswer
                        };
                    }
                }

                if (questionData === null) {
                    // Fallback if unable to generate a sensible question after many attempts
                    console.warn("Failed to generate a sensible unit conversion question after multiple attempts.");
                    return {
                        question: "Could not generate a sensible unit conversion question. Please try again.",
                        correctAnswer: 0,
                        units: "",
                        explanation: "", // No explanation
                        internalAnswerUnit: "",
                        answerDisplayDecimals: 0
                    };
                }

                return questionData;
            },

            'concentration_conversion': function() {
                let questionData = null;
                let attempts = 0;
                const MAX_ATTEMPTS = 100;

                // Expanded and refined common ratio values for more variation, including simple decimals
                const sensibleXValues = [10, 20, 25, 40, 50, 80, 100, 125, 200, 250, 400, 500, 1000, 2.5, 5, 12.5, 16, 62.5];
                const sensibleMgmlValuesFor1InX = [2, 4, 5, 8, 10, 12.5, 16, 20, 25, 40, 50, 80, 100, 125, 200, 250, 400, 500];

                const concentrationRules = [
                    // %w/v to mg/mL (multiply by 10)
                    {
                        type: '%w/v_to_mg/ml',
                        generateQuestionAndAnswer: () => {
                            let qVal, aVal;
                            let attemptsInner = 0;
                            while (attemptsInner < 50) {
                                qVal = getRandomDecimal(0.1, 79.9, 1);
                                aVal = qVal * 10;
                                if ((aVal % 1 === 0 || (aVal * 10) % 1 === 0)) { // Ensure answer is clean
                                    return { questionValue: qVal, correctAnswer: aVal };
                                }
                                attemptsInner++;
                            }
                            return null;
                        },
                        questionUnitDisplay: '%w/v',
                        answerUnitDisplay: 'mg/mL',
                        internalAnswerUnit: 'mg/mL',
                        // Explanation is no longer used for display
                        explanation: (qVal, aVal) => {
                            const formattedQVal = formatNumberForDisplay(qVal, 1);
                            const formattedAVal = formatNumberForDisplay(aVal, 1);
                            return `<strong>${formattedQVal}% w/v</strong> means ${formattedQVal} grams in 100 ml. To convert grams to milligrams, you multiply by 1000. So, $${formattedQVal}~\\text{g} \\times 1000 = ${formatNumberForDisplay(qVal * 1000, 0)}~\\text{mg}$ in 100 ml. To find milligrams per 1 ml, you divide by 100. Therefore, $${formatNumberForDisplay(qVal * 1000, 0)}~\\text{mg} \\div 100~\\text{ml} = ${formattedAVal}~\\text{mg/ml}$.`;
                        },
                        answerDisplayDecimals: 1
                    },
                    // mg/mL to %w/v (divide by 10)
                    {
                        type: 'mg/ml_to_%w/v',
                        generateQuestionAndAnswer: () => {
                            let qVal, aVal;
                            let attemptsInner = 0;
                            while (attemptsInner < 50) {
                                aVal = getRandomDecimal(0.1, 20.0, 1); // Target %w/v answer
                                qVal = aVal * 10; // Calculate mg/mL question value
                                if ((qVal % 1 === 0 || (qVal * 10) % 1 === 0)) { // Ensure question value is clean
                                    return { questionValue: qVal, correctAnswer: aVal };
                                }
                                attemptsInner++;
                            }
                            return null;
                        },
                        questionUnitDisplay: 'mg/mL',
                        answerUnitDisplay: '%w/v',
                        internalAnswerUnit: '%w/v',
                        // Explanation is no longer used for display
                        explanation: (qVal, aVal) => {
                            const formattedQVal = formatNumberForDisplay(qVal, 1);
                            const formattedAVal = formatNumberForDisplay(aVal, 1);
                            return `<strong>${formattedQVal} mg/mL</strong> means ${formattedQVal} milligrams in 1 ml. To find grams per 1 ml, you divide by 1000. So, $${formattedQVal}~\\text{mg} \\div 1000 = ${formatNumberForDisplay(qVal / 1000, 3)}~\\text{g}$ in 1 ml. To find grams per 100 ml (which is %w/v), you multiply by 100. Therefore, $${formatNumberForDisplay(qVal / 1000, 3)}~\\text{g} \\times 100 = ${formattedAVal}~\\text{g}$ in 100 ml, which is ${formattedAVal}% w/v.`;
                        },
                        answerDisplayDecimals: 1
                    },
                    // 1 in X to mg/mL (1000 / X)
                    {
                        type: '1_in_X_to_mg/ml',
                        generateQuestionAndAnswer: () => {
                            const sensibleXValues = [10, 20, 25, 40, 50, 80, 100, 125, 200, 250, 400, 500, 1000, 2.5, 5, 12.5, 16, 62.5];
                            let qVal = sensibleXValues[getRandomInt(0, sensibleXValues.length - 1)];
                            let aVal = 1000 / qVal;
                            // Ensure answer is clean (whole or 1 decimal)
                            if ((aVal % 1 === 0 || (aVal * 10) % 1 === 0)) {
                                return { questionValue: qVal, correctAnswer: aVal };
                            }
                            return null;
                        },
                        questionUnitDisplay: '1 in X',
                        answerUnitDisplay: 'mg/mL',
                        internalAnswerUnit: 'mg/mL',
                        // Explanation is no longer used for display
                        explanation: (qVal, aVal) => {
                            const formattedQVal = formatNumberForDisplay(qVal, (qVal % 1 === 0) ? 0 : 1);
                            const formattedAVal = formatNumberForDisplay(aVal, (aVal % 1 === 0) ? 0 : 1);
                            return `To convert <strong>1 in ${formattedQVal}</strong> to mg/mL: '1 in ${formattedQVal}' means 1 gram in ${formattedQVal} ml. Since 1 gram is 1000 mg, this means 1000 mg in ${formattedQVal} ml. To find milligrams per 1 ml, we divide the total milligrams by the total volume: $1000~\\text{mg} \\div ${formattedQVal}~\\text{ml} = ${formattedAVal}~\\text{mg/ml}$.`;
                        },
                        answerDisplayDecimals: 1
                    },
                    // mg/mL to 1 in X (1000 / mg/mL)
                    {
                        type: 'mg/ml_to_1_in_X',
                        generateQuestionAndAnswer: () => {
                            const sensibleMgmlValuesFor1InX = [2, 4, 5, 8, 10, 12.5, 16, 20, 25, 40, 50, 80, 100, 125, 200, 250, 400, 500];
                            let qVal = sensibleMgmlValuesFor1InX[getRandomInt(0, sensibleMgmlValuesFor1InX.length - 1)];
                            let aVal = 1000 / qVal;
                            // Ensure answer is clean (whole or 1 decimal)
                            if ((aVal % 1 === 0 || (aVal * 10) % 1 === 0)) {
                                return { questionValue: qVal, correctAnswer: aVal };
                            }
                            return null;
                        },
                        questionUnitDisplay: 'mg/mL',
                        answerUnitDisplay: '', // No unit in input box
                        internalAnswerUnit: 'ratio_X',
                        // Explanation is no longer used for display
                        explanation: (qVal, aVal) => {
                            const formattedQVal = formatNumberForDisplay(qVal, (qVal % 1 === 0) ? 0 : 1);
                            const formattedAVal = formatNumberForDisplay(aVal, (aVal % 1 === 0) ? 0 : 1);
                            return `To convert <strong>${formattedQVal} mg/mL</strong> to 1 in X: '${formattedQVal} mg/mL' means ${formattedQVal} milligrams in 1 ml. To express this as '1 in X', we need to know how many ml contain 1 gram (which is 1000 mg). We divide the desired total milligrams (1000 mg) by the concentration (${formattedQVal} mg/mL) to find the volume: $1000~\\text{mg} \\div ${formattedQVal}~\\text{mg/ml} = ${formattedAVal}~\\text{ml}$. Therefore, the concentration is 1 in ${formattedAVal}.`;
                        },
                        answerDisplayDecimals: 1
                    },
                    // NEW RULE: Dose & Volume to Concentration (mg/mL) - This was the new one moved here
                    {
                        type: 'dose_volume_to_concentration',
                        generateQuestionAndAnswer: () => {
                            // Target clean concentrations (answer)
                            const targetConcentrations = [0.1, 0.2, 0.25, 0.5, 1, 2, 2.5, 4, 5, 8, 10, 12.5, 15, 20];
                            // Sensible volumes for the question
                            const sensibleVolumes = [10, 20, 25, 50, 100, 125, 150, 200, 250, 300, 400, 500];
                            let concentration, volume, dose;
                            let attemptsInner = 0;
                            const MAX_ATTEMPTS_INNER = 50;

                            while (attemptsInner < 50) {
                                concentration = targetConcentrations[getRandomInt(0, targetConcentrations.length - 1)];
                                volume = sensibleVolumes[getRandomInt(0, sensibleVolumes.length - 1)];
                                dose = concentration * volume;

                                // Check if dose is a whole number or has max 1 decimal place, and is within a reasonable range
                                // Dose should not be excessively large (e.g., max 10,000 mg)
                                if ((dose % 1 === 0 || (dose * 10) % 1 === 0) && dose >= 10 && dose <= 10000) {
                                    return {
                                        questionDose: dose,
                                        questionVolume: volume,
                                        correctAnswer: concentration
                                    };
                                }
                                attemptsInner++;
                            }
                            return null; // Indicate failure to generate sensible values
                        },
                        questionUnitDisplay: '', // Not applicable for this question type directly
                        answerUnitDisplay: 'mg/mL',
                        internalAnswerUnit: 'mg/mL',
                        // Explanation is no longer used for display
                        explanation: (questionDose, questionVolume, correctAnswer) => {
                            const formattedDose = formatNumberForDisplay(questionDose, (questionDose % 1 === 0) ? 0 : 1);
                            const formattedVolume = formatNumberForDisplay(questionVolume, 0);
                            const formattedAnswer = formatNumberForDisplay(correctAnswer, (correctAnswer % 1 === 0) ? 0 : 1);
                            return `To find the concentration, you divide the total dose by the total volume. For example, $${formattedDose}~\\text{mg} \\div ${formattedVolume}~\\text{ml} = ${formattedAnswer}~\\text{mg/ml}$.`;
                        },
                        answerDisplayDecimals: 1
                    }
                ];

                while (questionData === null && attempts < MAX_ATTEMPTS) {
                    attempts++;
                    const rule = concentrationRules[getRandomInt(0, concentrationRules.length - 1)];

                    const generatedValues = rule.generateQuestionAndAnswer();

                    if (generatedValues === null) {
                        continue; // Failed to generate sensible values for this rule, try another
                    }

                    let questionValueNumerical, correctAnswerNumerical;
                    let questionDose, questionVolume; // For the new type

                    // Extract values based on rule type
                    if (rule.type === 'dose_volume_to_concentration') {
                        questionDose = generatedValues.questionDose;
                        questionVolume = generatedValues.questionVolume;
                        correctAnswerNumerical = generatedValues.correctAnswer;
                    } else {
                        questionValueNumerical = generatedValues.questionValue;
                        correctAnswerNumerical = generatedValues.correctAnswer;
                    }

                    // Perform general sensibility checks on the answer
                    let isSensible = true;
                    if (correctAnswerNumerical === null || !isFinite(correctAnswerNumerical)) { // Added !isFinite check
                        isSensible = false;
                    } else if (correctAnswerNumerical % 1 !== 0) { // If answer is a decimal
                        const decimalString = correctAnswerNumerical.toFixed(5).split('.')[1] || '';
                        if (decimalString.length > rule.answerDisplayDecimals && parseFloat(decimalString.substring(rule.answerDisplayDecimals)) !== 0) {
                            isSensible = false;
                        }
                    }

                    // Specific checks for question values if applicable (only for non 'dose_volume_to_concentration' type)
                    if (isSensible && rule.type !== 'dose_volume_to_concentration') {
                        if (questionValueNumerical === null || !isFinite(questionValueNumerical)) { // Added !isFinite check
                            isSensible = false;
                        } else if (questionValueNumerical % 1 !== 0) {
                            const decimalString = questionValueNumerical.toFixed(5).split('.')[1] || '';
                            if (decimalString.length > 3 && parseFloat(decimalString.substring(3)) !== 0) {
                                isSensible = false;
                            }
                        }
                        // Specific check for %w/v to ensure it's < 80
                        if (rule.questionUnitDisplay === '%w/v' && questionValueNumerical >= 80) {
                            isSensible = false;
                        }
                    }

                    if (isSensible) {
                        let formattedQuestionValue, formattedQuestionDose, formattedQuestionVolume;
                        if (rule.type === 'dose_volume_to_concentration') {
                            formattedQuestionDose = formatNumberForDisplay(questionDose, (questionDose % 1 === 0) ? 0 : 1);
                            formattedQuestionVolume = formatNumberForDisplay(questionVolume, 0);
                        } else {
                            formattedQuestionValue = formatNumberForDisplay(questionValueNumerical, 3);
                        }
                        const formattedCorrectAnswer = formatNumberForDisplay(correctAnswerNumerical, rule.answerDisplayDecimals);

                        let explanationText; // This will still be generated but not displayed
                        let mathJaxCalculation; // This will still be generated but not displayed
                        let questionText;

                        // Construct question text and explanation based on type
                        if (rule.type === '%w/v_to_mg/ml') {
                            questionText = `What is <strong>${formattedQuestionValue} ${rule.questionUnitDisplay}</strong> expressed as ${rule.answerUnitDisplay}?`;
                            explanationText = rule.explanation(questionValueNumerical, correctAnswerNumerical);
                            mathJaxCalculation = `$\\frac{${formattedQuestionValue}~\\text{g}}{100~\\text{ml}} \\times \\frac{1000~\\text{mg}}{1~\\text{g}} = \\frac{${formatNumberForDisplay(questionValueNumerical * 1000, 0)}~\\text{mg}}{100~\\text{ml}} = ${formattedCorrectAnswer}~\\text{mg/ml}$`;
                        } else if (rule.type === 'mg/ml_to_%w/v') {
                            questionText = `What is <strong>${formattedQuestionValue} mg/mL</strong> expressed as ${rule.answerUnitDisplay}?`;
                            explanationText = rule.explanation(questionValueNumerical, correctAnswerNumerical);
                            mathJaxCalculation = `$\\frac{${formattedQuestionValue}~\\text{mg}}{1~\\text{ml}} \\div \\frac{1000~\\text{mg}}{1~\\text{g}} \\times 100~\\text{ml} = ${formattedCorrectAnswer}\\%~\\text{w/v}$`;
                        } else if (rule.type === '1_in_X_to_mg/ml') {
                            questionText = `What is <strong>1 in ${formattedQuestionValue}</strong> expressed as ${rule.answerUnitDisplay}?`;
                            explanationText = rule.explanation(questionValueNumerical, correctAnswerNumerical);
                            mathJaxCalculation = `$\\frac{1~\\text{g}}{${formattedQuestionValue}~\\text{ml}} \\times \\frac{1000~\\text{mg}}{1~\\text{g}} = ${formattedCorrectAnswer}~\\text{mg/ml}$`;
                        } else if (rule.type === 'mg/ml_to_1_in_X') {
                            questionText = `What is <strong>${formattedQuestionValue} mg/mL</strong> expressed as 1 in X? Enter the value of X.`;
                            explanationText = rule.explanation(questionValueNumerical, correctAnswerNumerical);
                            mathJaxCalculation = `$\\frac{1000~\\text{mg}}{${formattedQuestionValue}~\\text{mg/ml}} = ${formattedCorrectAnswer}$`;
                        } else if (rule.type === 'dose_volume_to_concentration') {
                            questionText = `If <strong>${formattedQuestionDose} mg</strong> of a drug is dissolved in <strong>${formattedQuestionVolume} ml</strong> of solution, what is the concentration in <strong>mg/mL</strong>?`;
                            explanationText = rule.explanation(questionDose, questionVolume, correctAnswerNumerical);
                            mathJaxCalculation = `$\\frac{${formattedQuestionDose}~\\text{mg}}{${formattedQuestionVolume}~\\text{ml}} = ${formattedCorrectAnswer}~\\text{mg/ml}$`;
                        }

                        questionData = {
                            question: questionText,
                            correctAnswer: correctAnswerNumerical,
                            units: rule.answerUnitDisplay,
                            internalAnswerUnit: rule.internalAnswerUnit,
                            answerDisplayDecimals: rule.answerDisplayDecimals,
                            explanation: `${explanationText} ${mathJaxCalculation}` // Still generating, but not displayed
                        };
                    }
                }

                if (questionData === null) {
                    console.warn("Failed to generate a sensible concentration conversion question after multiple attempts.");
                    return {
                        question: "Could not generate a sensible concentration conversion question. Please try again.",
                        correctAnswer: 0,
                        units: "",
                        explanation: "", // No explanation
                        internalAnswerUnit: "",
                        answerDisplayDecimals: 0
                    };
                }
                return questionData;
            },

            'dosage_volume': function() {
                let questionData = null;
                let attempts = 0;
                const MAX_ATTEMPTS = 100;

                const dosageVolumeRules = [
                    // Calculate Dose: Concentration (mg/mL) x Volume (mL) = Dose (mg)
                    {
                        type: 'calculate_dose',
                        generateQuestionAndAnswer: () => {
                            let conc, vol, dose;
                            let attemptsInner = 0;
                            const MAX_ATTEMPTS_INNER = 50;
                            while (attemptsInner < MAX_ATTEMPTS_INNER) {
                                // Generate concentration in a sensible range (e.g., 1 to 100 mg/mL, favoring smaller values)
                                conc = getRandomInt(1, 20) * (Math.random() < 0.5 ? 1 : 5); // e.g., 1, 5, 10, 25, 100
                                if (conc === 0) continue; // Avoid division by zero if this were a divisor

                                // Generate volume in a sensible range (e.g., 1 to 200 mL, favoring smaller values)
                                vol = getRandomInt(1, 50) * (Math.random() < 0.5 ? 1 : 5); // e.g., 1, 5, 10, 25, 50, 100, 200
                                if (vol === 0) continue;

                                dose = conc * vol;

                                // Ensure dose is a whole number and within a reasonable range (e.g., 1 to 5000 mg)
                                if (dose % 1 === 0 && dose >= 1 && dose <= 5000) {
                                    return {
                                        questionConcentration: conc,
                                        questionVolume: vol,
                                        correctAnswer: dose
                                    };
                                }
                                attemptsInner++;
                            }
                            return null;
                        },
                        answerUnitDisplay: 'mg',
                        // Explanation is no longer used for display
                        explanation: (conc, vol, answer) => {
                            const formattedConc = formatNumberForDisplay(conc, (conc % 1 === 0) ? 0 : 1);
                            const formattedVol = formatNumberForDisplay(vol, 0);
                            const formattedAnswer = formatNumberForDisplay(answer, 0);
                            return `To find the total dose, you multiply the concentration by the volume. For example, $${formattedConc}~\\text{mg/ml} \\times ${formattedVol}~\\text{ml} = ${formattedAnswer}~\\text{mg}$.`;
                        },
                        answerDisplayDecimals: 0
                    },
                    // Calculate Volume: Dose (mg) / Concentration (mg/mL) = Volume (mL)
                    {
                        type: 'calculate_volume',
                        generateQuestionAndAnswer: () => {
                            let dose, conc, vol;
                            let attemptsInner = 0;
                            const MAX_ATTEMPTS_INNER = 50;
                            while (attemptsInner < MAX_ATTEMPTS_INNER) {
                                // Generate concentration that will result in a sensible volume (e.g., 1 to 50 mg/mL, favoring smaller values)
                                conc = getRandomInt(1, 20) * (Math.random() < 0.5 ? 1 : 5); // e.g., 1, 5, 10, 25, 50
                                if (conc === 0) continue;

                                // Generate dose such that dose / conc is a sensible volume (e.g., 1 to 500 mL, whole or 1 decimal)
                                // To ensure sensible volumes, generate volume first, then calculate dose
                                vol = getRandomInt(1, 100) * (Math.random() < 0.5 ? 1 : 5); // e.g., 1, 5, 10, 25, 50, 100, 250, 500
                                if (vol === 0) continue;

                                dose = conc * vol;

                                // Check if dose is reasonable (e.g., 10 to 10000 mg)
                                if (dose >= 10 && dose <= 10000 && (vol % 1 === 0 || (vol * 10) % 1 === 0)) {
                                    return {
                                        questionDose: dose,
                                        questionConcentration: conc,
                                        correctAnswer: vol
                                    };
                                }
                                attemptsInner++;
                            }
                            return null;
                        },
                        answerUnitDisplay: 'ml',
                        // Explanation is no longer used for display
                        explanation: (dose, conc, answer) => {
                            const formattedDose = formatNumberForDisplay(dose, 0);
                            const formattedConc = formatNumberForDisplay(conc, (conc % 1 === 0) ? 0 : 1);
                            const formattedAnswer = formatNumberForDisplay(answer, (answer % 1 === 0) ? 0 : 1);
                            return `To find the required volume, use the 'Need/Have $\\times$ Volume' approach:
                            <ol>
                                <li>You <strong>Need</strong>: $${formattedDose}~\\text{mg}$.</li>
                                <li>You <strong>Have</strong>: $${formattedConc}~\\text{mg}$ in 1 ml of solution.</li>
                                <li>Volume required: $\\frac{\\text{Need (in mg)}}{\\text{Have (in mg)}} \\times \\text{Volume of Have} = \\frac{${formattedDose}~\\text{mg}}{${formattedConc}~\\text{mg}} \\times 1~\\text{ml} = ${formattedAnswer}~\\text{ml}$.</li>
                            </ol>`;
                        },
                        answerDisplayDecimals: 1 // Allow 1 decimal for volume like 2.5 ml
                    },
                    // NEW: Cream %w/w to Active Ingredient (g or mg)
                    {
                        type: 'calculate_w_w_ingredient',
                        generateQuestionAndAnswer: () => {
                            let percent_ww, total_g, active_ingredient_g;
                            let attemptsInner = 0;
                            const MAX_ATTEMPTS_INNER = 50;
                            while (attemptsInner < MAX_ATTEMPTS_INNER) {
                                // Sensible percentages (0.1% to 20%)
                                percent_ww = getRandomDecimal(0.1, 20.0, 1);
                                // Sensible total grams (10g to 500g)
                                total_g = getRandomInt(1, 50) * (Math.random() < 0.5 ? 1 : 5); // e.g., 1, 5, 10, 25, 50, 100, 250, 500
                                if (total_g === 0) continue;

                                active_ingredient_g = (percent_ww / 100) * total_g;

                                // Ensure answer is clean (whole or 1-2 decimals) and within a reasonable range
                                if ((active_ingredient_g * 100) % 1 === 0 && active_ingredient_g > 0.001 && active_ingredient_g <= 50) { // Max 2 decimal places, min 1mg
                                    return {
                                        questionPercentWW: percent_ww,
                                        questionTotalG: total_g,
                                        correctAnswer: active_ingredient_g
                                    };
                                }
                                attemptsInner++;
                            }
                            return null;
                        },
                        answerUnitDisplay: (answer) => { // Dynamic unit display
                            return answer < 1 ? 'mg' : 'g';
                        },
                        internalAnswerUnit: 'dynamic_mass',
                        // Explanation is no longer used for display
                        explanation: (percent_ww, total_g, answer) => {
                            const formattedPercent = formatNumberForDisplay(percent_ww, 1);
                            const formattedTotalG = formatNumberForDisplay(total_g, 0);
                            let formattedAnswer;
                            let mathJaxAnswer;
                            if (answer < 1) { // Display in mg
                                formattedAnswer = formatNumberForDisplay(answer * 1000, 0);
                                mathJaxAnswer = `$${formattedAnswer}~\\text{mg}$`;
                            } else { // Display in g
                                formattedAnswer = formatNumberForDisplay(answer, (answer % 1 === 0) ? 0 : 2);
                                mathJaxAnswer = `$${formattedAnswer}~\\text{g}$`;
                            }

                            return `<strong>${formattedPercent}% w/w</strong> means ${formattedPercent} grams of active ingredient in 100 grams of cream. To find the amount in ${formattedTotalG} grams, you calculate: $(\\frac{${formattedPercent}}{100}) \\times ${formattedTotalG}~\\text{g} = ${mathJaxAnswer}$.`;
                        },
                        answerDisplayDecimals: (answer) => { // Dynamic decimal places for answer
                            return answer < 1 ? 0 : 2; // 0 for mg, 2 for g
                        }
                    },
                    // NEW: Volume from Dose (mg or g) and %w/v solution (Need/Have x Volume)
                    {
                        type: 'calculate_volume_from_dose_and_percent_solution',
                        generateQuestionAndAnswer: () => {
                            let required_dose_mg, percent_wv, volume_needed;
                            let attemptsInner = 0;
                            const MAX_ATTEMPTS_INNER = 50;
                            while (attemptsInner < MAX_ATTEMPTS_INNER) {
                                // Generate target volume first to ensure clean numbers
                                volume_needed = getRandomInt(1, 100) * (Math.random() < 0.5 ? 1 : 5); // e.g., 1, 5, 10, 25, 50, 100, 250, 500
                                if (volume_needed === 0) continue;

                                // Generate solution %w/v
                                percent_wv = getRandomDecimal(0.1, 10.0, 1); // e.g., 0.1, 0.5, 1.0, 2.5, 5.0, 10.0
                                if (percent_wv === 0) continue;

                                // Calculate the amount of drug in 100ml of the solution (in mg)
                                const have_mg_in_100ml = percent_wv * 1000;

                                // Calculate required dose in mg based on desired volume and concentration
                                required_dose_mg = (volume_needed / 100) * have_mg_in_100ml;

                                // Decide if dose should be presented in grams or milligrams
                                let questionDoseUnit = 'mg';
                                let questionDoseValue = required_dose_mg;
                                if (required_dose_mg >= 1000 && Math.random() < 0.5) { // If dose is 1g or more, 50% chance to show in grams
                                    questionDoseUnit = 'g';
                                    questionDoseValue = required_dose_mg / 1000;
                                    // Ensure grams value is clean (e.g., 1.5g, 2g, not 1.234g)
                                    if (!((questionDoseValue * 10) % 1 === 0)) {
                                        continue; // Regenerate if not clean decimal for grams
                                    }
                                }

                                // Ensure required_dose_mg is sensible (e.g., 10 to 10000 mg)
                                // And volume_needed is sensible (e.g., 0.1 to 500 ml)
                                if (required_dose_mg >= 10 && required_dose_mg <= 10000 &&
                                    volume_needed >= 0.1 && volume_needed <= 500 &&
                                    (volume_needed * 100) % 1 === 0) { // Allow 0, 1 or 2 decimal places for volume
                                    return {
                                        questionDoseValue: questionDoseValue,
                                        questionDoseUnit: questionDoseUnit,
                                        questionPercentWV: percent_wv,
                                        correctAnswer: volume_needed
                                    };
                                }
                                attemptsInner++;
                            }
                            return null;
                        },
                        answerUnitDisplay: 'ml',
                        internalAnswerUnit: 'ml',
                        // Explanation is no longer used for display
                        explanation: (questionDoseValue, questionPercentWV, correctAnswer, questionDoseUnit) => {
                            const formattedQuestionPercentWV = formatNumberForDisplay(questionPercentWV, 1);
                            const formattedAnswer = formatNumberForDisplay(correctAnswer, (correctAnswer % 1 === 0) ? 0 : 2); // Show 0 or 2 decimals for ml

                            // Determine the 'Have' part in grams and its corresponding volume (100 ml)
                            const have_g_in_100ml = questionPercentWV; // Y% w/v means Y g in 100ml
                            const formattedHaveGIn100ml = formatNumberForDisplay(have_g_in_100ml, 1);

                            // Prepare parts for the MathJax fraction without their own $ delimiters
                            let needValueAndUnit;
                            let haveValueAndUnit;

                            if (questionDoseUnit === 'g') {
                                needValueAndUnit = `${formatNumberForDisplay(questionDoseValue, (questionDoseValue % 1 === 0) ? 0 : 1)}~\\text{g}`;
                                haveValueAndUnit = `${formattedHaveGIn100ml}~\\text{g}`;
                            } else { // questionDoseUnit is 'mg'
                                needValueAndUnit = `${formatNumberForDisplay(questionDoseValue, 0)}~\\text{mg}`;
                                haveValueAndUnit = `${formatNumberForDisplay(have_mg_in_100ml, 0)}~\\text{mg}`;
                            }

                            return `To find the required volume:
                            <ol>
                                <li>First, understand what the solution's concentration means:
                                    <br><strong>${formattedQuestionPercentWV}% w/v</strong> means you <strong>Have</strong>: $${formattedHaveGIn100ml}~\\text{g}$ in 100 ml of solution.
                                    ${questionDoseUnit === 'mg' ? `<br>To match units with your needed dose, convert this to milligrams: $${formattedHaveGIn100ml}~\\text{g} \\times 1000~\\frac{\\text{mg}}{\\text{g}} = ${formatNumberForDisplay(have_mg_in_100ml, 0)}~\\text{mg}$ in 100 ml.` : ''}
                                </li>
                                <li>Then, use the 'Need/Have $\\times$ Volume' approach to find the required volume:
                                    <br>You <strong>Need</strong>: $${needValueAndUnit}$.
                                    <br>You <strong>Have</strong>: $${haveValueAndUnit}$ in 100 ml.
                                    <br>Volume required: $\\frac{${needValueAndUnit}}{${haveValueAndUnit}} \\times 100~\\text{ml} = ${formattedAnswer}~\\text{ml}$.
                                </li>
                            </ol>`;
                        },
                        answerDisplayDecimals: 2
                    }
                ];

                while (questionData === null && attempts < MAX_ATTEMPTS) {
                    attempts++;
                    const rule = dosageVolumeRules[getRandomInt(0, dosageVolumeRules.length - 1)];

                    const generatedValues = rule.generateQuestionAndAnswer();

                    if (generatedValues === null) {
                        continue; // Failed to generate sensible values for this rule, try another
                    }

                    let correctAnswerNumerical = generatedValues.correctAnswer;

                    // Perform general sensibility checks on the answer
                    let isSensible = true;
                    if (correctAnswerNumerical === null || !isFinite(correctAnswerNumerical)) {
                        isSensible = false;
                    } else if (correctAnswerNumerical % 1 !== 0) { // If answer is a decimal
                        const decimalString = correctAnswerNumerical.toFixed(5).split('.')[1] || '';
                        let maxDecimals = (typeof rule.answerDisplayDecimals === 'function') ? rule.answerDisplayDecimals(correctAnswerNumerical) : rule.answerDisplayDecimals;
                        if (decimalString.length > maxDecimals && parseFloat(decimalString.substring(maxDecimals)) !== 0) {
                            isSensible = false;
                        }
                    }

                    if (isSensible) {
                        let questionText;
                        const answerDecimals = (typeof rule.answerDisplayDecimals === 'function') ? rule.answerDisplayDecimals(correctAnswerNumerical) : rule.answerDisplayDecimals;
                        const formattedCorrectAnswer = formatNumberForDisplay(correctAnswerNumerical, answerDecimals);
                        const answerUnit = (typeof rule.answerUnitDisplay === 'function') ? rule.answerUnitDisplay(correctAnswerNumerical) : rule.answerUnitDisplay;

                        let explanationContent; // This will still be generated but not displayed

                        // Dynamically call the explanation function with the correct parameters for each rule type
                        if (rule.type === 'calculate_dose') {
                            const formattedConc = formatNumberForDisplay(generatedValues.questionConcentration, (generatedValues.questionConcentration % 1 === 0) ? 0 : 1);
                            const formattedVol = formatNumberForDisplay(generatedValues.questionVolume, 0);
                            questionText = `If a solution has a concentration of <strong>${formattedConc} mg/mL</strong>, how many milligrams of drug are in <strong>${formattedVol} ml</strong> of this solution?`;
                            explanationContent = rule.explanation(
                                generatedValues.questionConcentration,
                                generatedValues.questionVolume,
                                correctAnswerNumerical
                            );
                        } else if (rule.type === 'calculate_volume') {
                            const formattedDose = formatNumberForDisplay(generatedValues.questionDose, 0);
                            const formattedConc = formatNumberForDisplay(generatedValues.questionConcentration, (generatedValues.questionConcentration % 1 === 0) ? 0 : 1);
                            questionText = `How many millilitres of a solution with a concentration of <strong>${formattedConc} mg/mL</strong> would be required to provide a dose of <strong>${formattedDose} mg</strong>?`;
                            explanationContent = rule.explanation(
                                generatedValues.questionDose,
                                generatedValues.questionConcentration,
                                correctAnswerNumerical
                            );
                        } else if (rule.type === 'calculate_w_w_ingredient') {
                            const formattedPercent = formatNumberForDisplay(generatedValues.questionPercentWW, 1);
                            const formattedTotalG = formatNumberForDisplay(generatedValues.questionTotalG, 0);
                            questionText = `A cream is described as <strong>${formattedPercent}% w/w</strong>. How much active ingredient is there in <strong>${formattedTotalG} g</strong> of this cream?`;
                            explanationContent = rule.explanation(
                                generatedValues.questionPercentWW,
                                generatedValues.questionTotalG,
                                correctAnswerNumerical
                            );
                        } else if (rule.type === 'calculate_volume_from_dose_and_percent_solution') {
                            const formattedDoseValue = formatNumberForDisplay(generatedValues.questionDoseValue, (generatedValues.questionDoseValue % 1 === 0) ? 0 : 1);
                            const formattedPercentWV = formatNumberForDisplay(generatedValues.questionPercentWV, 1);
                            questionText = `How many ml of solution are required to provide a dose of <strong>${formattedDoseValue} ${generatedValues.questionDoseUnit}</strong> from a <strong>${formattedPercentWV}% w/v</strong> solution?`;
                            explanationContent = rule.explanation(
                                generatedValues.questionDoseValue,
                                generatedValues.questionPercentWV,
                                correctAnswerNumerical,
                                generatedValues.questionDoseUnit
                            );
                        }

                        questionData = {
                            question: questionText,
                            correctAnswer: correctAnswerNumerical,
                            units: answerUnit,
                            internalAnswerUnit: rule.internalAnswerUnit,
                            answerDisplayDecimals: answerDecimals,
                            explanation: explanationContent // Still generating, but not displayed
                        };
                    }
                }

                if (questionData === null) {
                    console.warn("Failed to generate a sensible dosage & volume question after multiple attempts.");
                    return {
                        question: "Could not generate a sensible dosage & volume question. Please try again.",
                        correctAnswer: 0,
                        units: "",
                        explanation: "", // No explanation
                        internalAnswerUnit: "",
                        answerDisplayDecimals: 0
                    };
                }
                return questionData;
            }
        };

        // --- Core Quiz Logic ---

        function startQuiz(topicId) {
            selectedTopicId = topicId; // Store the topic ID
            const selectedTopicGenerator = questionGenerators[topicId];
            if (typeof selectedTopicGenerator !== 'function') { // More robust check
                // Using a simple alert for now, but consider a custom modal for better UX
                alert('Invalid topic selected or generator not found!');
                console.error("Generator for topic '" + topicId + "' is not a function:", selectedTopicGenerator);
                return;
            }

            currentQuizQuestions = [];
            for (let i = 0; i < TOTAL_QUESTIONS_PER_QUIZ; i++) {
                try {
                    currentQuizQuestions.push(selectedTopicGenerator());
                } catch (e) {
                    console.error(`Error generating question for topic ${topicId}:`, e);
                    // Fallback or display an error message to the user
                    alert(`Error generating question for this topic. Please try another topic or refresh. Details: ${e.message}`);
                    return; // Stop quiz initiation if a question fails to generate
                }
            }

            currentQuestionIndex = 0;
            score = 0;
            secondsElapsed = 0;
            scoreTracker.textContent = score;
            totalQuestionsSpan.textContent = TOTAL_QUESTIONS_PER_QUIZ; // Set total questions display
            quizTitle.textContent = formatTopicTitle(topicId); // Update navbar title

            topicSelectionDiv.style.display = 'none';
            quizSummaryDiv.style.display = 'none';
            quizSectionDiv.style.display = 'block';

            restartQuizBtn.style.display = 'none';
            checkAnswerBtn.style.display = 'inline-block';
            nextQuestionBtn.style.display = 'inline-block';
            checkAnswerBtn.disabled = false;
            nextQuestionBtn.disabled = true;
            userAnswerInput.value = '';
            userAnswerInput.disabled = false;

            startTimer();
            displayQuestion();
        }

        function displayQuestion() {
            if (currentQuestionIndex >= currentQuizQuestions.length) {
                endQuiz();
                return;
            }

            const question = currentQuizQuestions[currentQuestionIndex];
            currentQuestionNum.textContent = currentQuestionIndex + 1;
            questionText.innerHTML = question.question;
            userAnswerInput.value = ''; // Clear previous answer
            userAnswerInput.disabled = false;
            answerUnitDisplay.textContent = question.units; // Display units next to input
            feedbackMessage.style.display = 'none';
            solutionExplanation.style.display = 'none'; // Ensure solution explanation is hidden
            feedbackMessage.className = 'feedback-message';

            if (window.MathJax) {
                // Only typeset the question text, not the solution explanation
                MathJax.typesetPromise([questionText]).catch((err) => console.error("MathJax typesetting error:", err));
            }

            checkAnswerBtn.disabled = false;
            nextQuestionBtn.disabled = true;
            userAnswerInput.focus(); // Focus on the input field
        }

        function checkAnswer() {
            const userAnswerRaw = userAnswerInput.value;
            let userAnswer = parseFloat(userAnswerRaw);

            // Normalize user input to a fixed precision to avoid floating point comparison issues
            // Assuming answers are generally expected to be up to 3 decimal places for robustness
            if (!isNaN(userAnswer)) {
                userAnswer = Math.round(userAnswer * 1000) / 1000;
            }

            const currentQuestion = currentQuizQuestions[currentQuestionIndex];
            const correctAnswer = currentQuestion.correctAnswer; // This is the numerical value

            console.log("User Input Raw:", userAnswerRaw);
            console.log("Parsed & Normalized User Answer:", userAnswer);
            console.log("Correct Answer Numerical:", correctAnswer);
            console.log("Absolute difference:", Math.abs(userAnswer - correctAnswer));
            const tolerance = 0.001; // For up to 2-3 decimal places accuracy
            console.log("Tolerance:", tolerance);
            console.log("Is within tolerance:", Math.abs(userAnswer - correctAnswer) < tolerance);
            console.log("Current Question:", currentQuestion);


            if (isNaN(userAnswer)) {
                feedbackMessage.textContent = "Please enter a numerical answer.";
                feedbackMessage.className = 'feedback-message feedback-incorrect';
                feedbackMessage.style.display = 'block';
                return;
            }

            if (Math.abs(userAnswer - correctAnswer) < tolerance) {
                score++;
                feedbackMessage.textContent = "Correct!";
                feedbackMessage.className = 'feedback-message feedback-correct';
            } else {
                let feedbackAnswerDisplayString;
                // Use internalAnswerUnit to determine how to format the correct answer in feedback
                if (currentQuestion.internalAnswerUnit === 'ratio_X') {
                    feedbackAnswerDisplayString = `1 in ${formatNumberForDisplay(correctAnswer, currentQuestion.answerDisplayDecimals)}`;
                } else if (currentQuestion.internalAnswerUnit === 'dynamic_mass') {
                    // currentQuestion.units is already the string ('mg' or 'g')
                    const unit = currentQuestion.units;
                    // currentQuestion.answerDisplayDecimals is already the number (0 or 2)
                    const decimals = currentQuestion.answerDisplayDecimals;
                    feedbackAnswerDisplayString = `${formatNumberForDisplay(correctAnswer * (unit === 'mg' ? 1000 : 1), decimals)} ${unit}`;
                }
                else {
                    feedbackAnswerDisplayString = `${formatNumberForDisplay(correctAnswer, currentQuestion.answerDisplayDecimals)} ${currentQuestion.units}`;
                }

                feedbackMessage.textContent = `Incorrect. The correct answer was ${feedbackAnswerDisplayString}.`;
                feedbackMessage.className = 'feedback-message feedback-incorrect';
            }

            scoreTracker.textContent = score;
            feedbackMessage.style.display = 'block';
            solutionExplanation.style.display = 'none'; // Explicitly ensure solution explanation is hidden

            checkAnswerBtn.disabled = true;
            nextQuestionBtn.disabled = false;
            userAnswerInput.disabled = true; // Disable input after checking
        }

        function nextQuestion() {
            currentQuestionIndex++;
            displayQuestion();
        }

        function endQuiz() {
                clearInterval(timerInterval);
                quizSummaryDiv.style.display = 'block';
                quizSectionDiv.style.display = 'none';

                document.getElementById('finalScore').textContent = score;
                document.getElementById('finalTotal').textContent = TOTAL_QUESTIONS_PER_QUIZ;
                document.getElementById('finalTime').textContent = formatTime(secondsElapsed);
            }

            function startTimer() {
                clearInterval(timerInterval);
                secondsElapsed = 0;
                timeTracker.textContent = formatTime(secondsElapsed);
                timerInterval = setInterval(() => {
                    secondsElapsed++;
                    timeTracker.textContent = formatTime(secondsElapsed);
                }, 1000);
            }

            function formatTime(totalSeconds) {
                const minutes = Math.floor(totalSeconds / 60);
                const remainingSeconds = totalSeconds % 60;
                return `${minutes} minute${minutes === 1 ? '' : 's'} ${remainingSeconds} second${remainingSeconds === 1 ? '' : 's'}`;
            }

            function formatTopicTitle(topicId) {
                return topicId.replace(/_/g, ' ').replace(/\b\w/g, char => char.toUpperCase()) + ' Questions';
            }

            // --- Event Listeners ---

            // Topic selection buttons
            document.querySelectorAll('.topic-button').forEach(button => {
                button.addEventListener('click', (event) => {
                    const topic = event.currentTarget.dataset.topic;
                    startQuiz(topic);
                });
            });

            checkAnswerBtn.addEventListener('click', checkAnswer);
            nextQuestionBtn.addEventListener('click', nextQuestion);
            // Use selectedTopicId for restarting the quiz
            restartQuizBtn.addEventListener('click', () => startQuiz(selectedTopicId));
            summaryRestartBtn.addEventListener('click', () => startQuiz(selectedTopicId));

            backToTopicsBtn.addEventListener('click', () => {
                quizSummaryDiv.style.display = 'none';
                topicSelectionDiv.style.display = 'block';
                quizTitle.textContent = 'Random Questions'; // Reset navbar title
            });

            // Allow pressing Enter to check answer or move to next question
            userAnswerInput.addEventListener('keypress', (event) => {
                if (event.key === 'Enter') {
                    if (!checkAnswerBtn.disabled) {
                        checkAnswer();
                    } else if (!nextQuestionBtn.disabled) {
                        nextQuestion();
                    }
                }
            });

            // --- Initial Setup ---
            window.onload = () => {
                // Ensure topic selection is visible at start
                topicSelectionDiv.style.display = 'block';
                quizSectionDiv.style.display = 'none';
                quizSummaryDiv.style.display = 'none';
            };

        </script>
    </body>
    </html>
